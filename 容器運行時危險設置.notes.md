æˆ‘ä¾†ç‚ºä½ è©³ç´°è§£é‡‹é€™äº›å‘½ä»¤ä»¥åŠç›¸é—œçš„å®‰å…¨é¢¨éšªã€‚

## å‘½ä»¤è§£æ

### 1. æª¢æŸ¥ç‰¹æ¬Šå®¹å™¨
```bash
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{" "}{.spec.containers[*].securityContext.privileged}{"\n"}{end}' | grep true
```

**åŠŸèƒ½èªªæ˜ï¼š**
- `--all-namespaces`: æœå°‹æ‰€æœ‰å‘½åç©ºé–“
- `jsonpath`: æå– Pod åç¨±ã€å‘½åç©ºé–“å’Œ privileged è¨­å®š
- `grep true`: éæ¿¾å‡ºå•Ÿç”¨ç‰¹æ¬Šæ¨¡å¼çš„å®¹å™¨

### 2. æª¢æŸ¥ä»¥ root é‹è¡Œçš„ Pod
```bash
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{" "}{.spec.securityContext.runAsUser}{"\n"}{end}' | grep -E "(^| )0( |$)"
```

**åŠŸèƒ½èªªæ˜ï¼š**
- æå– Pod çš„ `runAsUser` è¨­å®š
- `grep -E "(^| )0( |$)"`: å°‹æ‰¾ UID ç‚º 0ï¼ˆrootï¼‰çš„ Pod

### 3. æª¢æŸ¥ hostNetwork çš„ Pod
```bash
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{" "}{.spec.hostNetwork}{"\n"}{end}' | grep true
```

**åŠŸèƒ½èªªæ˜ï¼š**
- æª¢æŸ¥ä½¿ç”¨ä¸»æ©Ÿç¶²è·¯å‘½åç©ºé–“çš„ Pod

## å®‰å…¨å±å®³åˆ†æ

### ğŸ”´ ç‰¹æ¬Šå®¹å™¨ (Privileged Containers)
**å±å®³ï¼š**
- **å®Œå…¨ä¸»æ©Ÿå­˜å–æ¬Šé™**ï¼šå¯ä»¥å­˜å–ä¸»æ©Ÿçš„æ‰€æœ‰è¨­å‚™å’Œç³»çµ±èª¿ç”¨
- **ç¹éå®‰å…¨æ©Ÿåˆ¶**ï¼šå¿½ç•¥ SELinuxã€AppArmor ç­‰å®‰å…¨ç­–ç•¥
- **å®¹å™¨é€ƒé€¸é¢¨éšª**ï¼šæ›´å®¹æ˜“çªç ´å®¹å™¨éš”é›¢
- **æƒ¡æ„ç¨‹å¼ç¢¼åŸ·è¡Œ**ï¼šå¯åŸ·è¡Œä»»ä½•ç³»çµ±ç´šæ“ä½œ

### ğŸ”´ Root ç”¨æˆ¶é‹è¡Œ
**å±å®³ï¼š**
- **æ¬Šé™æå‡æ”»æ“Š**ï¼šæ”»æ“Šè€…ç²å¾—å®¹å™¨å…§æœ€é«˜æ¬Šé™
- **æ–‡ä»¶ç³»çµ±ç ´å£**ï¼šå¯ä¿®æ”¹æˆ–åˆªé™¤é‡è¦ç³»çµ±æ–‡ä»¶
- **æ©«å‘ç§»å‹•**ï¼šæ›´å®¹æ˜“æ”»æ“Šå…¶ä»–ç³»çµ±çµ„ä»¶
- **æ•¸æ“šæ´©éœ²**ï¼šå¯å­˜å–æ•æ„Ÿé…ç½®å’Œæ•¸æ“š

### ğŸ”´ hostNetwork æ¨¡å¼
**å±å®³ï¼š**
- **ç¶²è·¯éš”é›¢å¤±æ•ˆ**ï¼šç›´æ¥ä½¿ç”¨ä¸»æ©Ÿç¶²è·¯å †ç–Š
- **ç«¯å£è¡çª**ï¼šå¯èƒ½èˆ‡ä¸»æ©Ÿæœå‹™ç™¼ç”Ÿè¡çª
- **ç¶²è·¯ç›£è½**ï¼šå¯ç›£è½ä¸»æ©Ÿä¸Šçš„ç¶²è·¯æµé‡
- **ç¹éç¶²è·¯ç­–ç•¥**ï¼šå¿½ç•¥ Kubernetes ç¶²è·¯æ”¿ç­–

## è§£æ±ºæ–¹æ¡ˆ

### ğŸ›¡ï¸ å®‰å…¨é…ç½®å»ºè­°

**1. ç¦ç”¨ç‰¹æ¬Šæ¨¡å¼**
```yaml
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: app
    securityContext:
      privileged: false  # æ˜ç¢ºç¦ç”¨
      allowPrivilegeEscalation: false
```

**2. ä½¿ç”¨é root ç”¨æˆ¶**
```yaml
apiVersion: v1
kind: Pod
spec:
  securityContext:
    runAsUser: 1000      # ä½¿ç”¨é root UID
    runAsGroup: 1000     # è¨­å®šç¾¤çµ„
    runAsNonRoot: true   # ç¢ºä¿é root
    fsGroup: 1000
```

**3. é¿å… hostNetwork**
```yaml
apiVersion: v1
kind: Pod
spec:
  hostNetwork: false     # ä½¿ç”¨ Pod ç¶²è·¯
  # ä½¿ç”¨ Service æˆ– Ingress æš´éœ²æœå‹™
```

### ğŸ›¡ï¸ Pod Security Standards
```yaml
apiVersion: v1
kind: Namespace
metadata:
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

### ğŸ›¡ï¸ ç¶²è·¯ç­–ç•¥
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

## å±éšªå…§å®¹è­˜åˆ¥æ¨™æº–

### ğŸš¨ é«˜é¢¨éšªé…ç½®
- `privileged: true`
- `runAsUser: 0` æˆ–æœªè¨­å®š
- `hostNetwork: true`
- `hostPID: true`
- `hostIPC: true`
- `capabilities` éåº¦æˆæ¬Š

### ğŸš¨ å±éšª Volume æ›è¼‰
```yaml
# å±éšªç¤ºä¾‹
volumes:
- name: host-root
  hostPath:
    path: /           # æ›è¼‰æ•´å€‹ä¸»æ©Ÿæ ¹ç›®éŒ„
- name: docker-sock
  hostPath:
    path: /var/run/docker.sock  # Docker socket
```

### ğŸ›¡ï¸ ç›£æ§å’Œç¨½æ ¸

**ä½¿ç”¨ OPA Gatekeeper é€²è¡Œç­–ç•¥æ§åˆ¶**
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredsecuritycontext
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredSecurityContext
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredsecuritycontext
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          container.securityContext.privileged == true
          msg := "ç‰¹æ¬Šå®¹å™¨è¢«ç¦æ­¢"
        }
```

**å®šæœŸæƒæè…³æœ¬**
```bash
#!/bin/bash
echo "=== å®‰å…¨æƒæå ±å‘Š ==="
echo "ç‰¹æ¬Šå®¹å™¨ï¼š"
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{" "}{.spec.containers[*].securityContext.privileged}{"\n"}{end}' | grep true

echo -e "\nRoot é‹è¡Œçš„å®¹å™¨ï¼š"
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{" "}{.spec.securityContext.runAsUser}{"\n"}{end}' | grep -E "(^| )0( |$)"

echo -e "\nhostNetwork å®¹å™¨ï¼š"
kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{.metadata.namespace}{" "}{.metadata.name}{" "}{.spec.hostNetwork}{"\n"}{end}' | grep true
```

é€™äº›å‘½ä»¤æ˜¯å¾ˆå¥½çš„å®‰å…¨æª¢æŸ¥å·¥å…·ï¼Œå»ºè­°å®šæœŸåŸ·è¡Œä»¥ç¢ºä¿é›†ç¾¤å®‰å…¨ã€‚é‡é»æ˜¯å»ºç«‹ã€Œæœ€å°æ¬Šé™åŸå‰‡ã€å’Œã€Œç¸±æ·±é˜²ç¦¦ã€ç­–ç•¥ã€‚


æˆ‘ä¾†è©³ç´°è§£é‡‹é€™äº› Kubernetes å®‰å…¨æ¦‚å¿µï¼š

## NetworkPolicy ä¸­çš„ policyTypes

### ğŸŒ Ingress å’Œ Egress èªªæ˜

**Ingressï¼ˆå…¥ç«™æµé‡ï¼‰**
- **å®šç¾©**ï¼šé€²å…¥ Pod çš„ç¶²è·¯æµé‡
- **æ–¹å‘**ï¼šå¤–éƒ¨ â†’ Pod
- **æ§åˆ¶**ï¼šèª°å¯ä»¥é€£æ¥åˆ°ä½ çš„ Pod

**Egressï¼ˆå‡ºç«™æµé‡ï¼‰**
- **å®šç¾©**ï¼šå¾ Pod ç™¼å‡ºçš„ç¶²è·¯æµé‡  
- **æ–¹å‘**ï¼šPod â†’ å¤–éƒ¨
- **æ§åˆ¶**ï¼šPod å¯ä»¥é€£æ¥åˆ°å“ªè£¡

### ğŸ“ å¯¦éš›ç¯„ä¾‹

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-app-policy
spec:
  podSelector:
    matchLabels:
      app: web
  policyTypes:
  - Ingress  # æ§åˆ¶å…¥ç«™æµé‡
  - Egress   # æ§åˆ¶å‡ºç«™æµé‡
  
  ingress:  # å…è¨±èª°é€£æ¥é€²ä¾†
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8080
      
  egress:   # å…è¨±é€£æ¥åˆ°å“ªè£¡
  - to:
    - podSelector:
        matchLabels:
          app: database
    ports:
    - protocol: TCP
      port: 5432
```

### ğŸ”’ ä¸åŒç­–ç•¥çµ„åˆçš„å½±éŸ¿

```yaml
# åªæ§åˆ¶å…¥ç«™ï¼Œå‡ºç«™ä¸é™åˆ¶
policyTypes:
- Ingress

# åªæ§åˆ¶å‡ºç«™ï¼Œå…¥ç«™ä¸é™åˆ¶  
policyTypes:
- Egress

# å®Œå…¨éš”é›¢ï¼ˆæ¨è–¦ï¼‰
policyTypes:
- Ingress
- Egress
```

## fsGroup è©³è§£

### ğŸ’¾ fsGroup çš„ä½œç”¨

**ä¸»è¦åŠŸèƒ½**ï¼šè¨­å®šå®¹å™¨å…§æ›è¼‰ Volume çš„ç¾¤çµ„æ‰€æœ‰æ¬Š

```yaml
apiVersion: v1
kind: Pod
spec:
  securityContext:
    fsGroup: 2000      # è¨­å®šæª”æ¡ˆç³»çµ±ç¾¤çµ„ ID
    runAsUser: 1000    # ä½¿ç”¨è€… ID
    runAsGroup: 1000   # ä¸»è¦ç¾¤çµ„ ID
  containers:
  - name: app
    volumeMounts:
    - name: data
      mountPath: /data
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: app-data
```

### ğŸ”§ å¯¦éš›æ•ˆæœ

**æ²’æœ‰ fsGroup æ™‚**ï¼š
```bash
# åœ¨å®¹å™¨å…§æª¢æŸ¥
ls -la /data
# drwxr-xr-x 2 root root 4096 Jan 1 12:00 /data
# ä¸€èˆ¬ç”¨æˆ¶å¯èƒ½ç„¡æ³•å¯«å…¥
```

**è¨­å®š fsGroup: 2000 å¾Œ**ï¼š
```bash
ls -la /data  
# drwxrwsr-x 2 root 2000 4096 Jan 1 12:00 /data
# ç¾¤çµ„ 2000 çš„æˆå“¡å¯ä»¥è®€å¯«
```

### ğŸ¯ ä½¿ç”¨æƒ…å¢ƒ

```yaml
# å¤šå®¹å™¨å…±äº« Volume çš„æƒ…æ³
apiVersion: v1
kind: Pod
spec:
  securityContext:
    fsGroup: 3000  # å…±åŒçš„ç¾¤çµ„ ID
  containers:
  - name: writer
    securityContext:
      runAsUser: 1001
  - name: reader  
    securityContext:
      runAsUser: 1002
  # å…©å€‹å®¹å™¨éƒ½å±¬æ–¼ç¾¤çµ„ 3000ï¼Œå¯ä»¥å…±äº«æª”æ¡ˆ
```

## hostPID å’Œ hostIPC

### ğŸ–¥ï¸ hostPID (Host Process ID Namespace)

**åŠŸèƒ½**ï¼šå®¹å™¨æ˜¯å¦ä½¿ç”¨ä¸»æ©Ÿçš„ PID å‘½åç©ºé–“

```yaml
# å±éšªé…ç½®
apiVersion: v1
kind: Pod
spec:
  hostPID: true  # å¯ä»¥çœ‹åˆ°ä¸»æ©Ÿä¸Šæ‰€æœ‰ç¨‹åº
  containers:
  - name: debug
    image: busybox
```

**å±å®³ç¤ºä¾‹**ï¼š
```bash
# åœ¨å®¹å™¨å…§åŸ·è¡Œ
ps aux
# å¯ä»¥çœ‹åˆ°ä¸»æ©Ÿä¸Šæ‰€æœ‰ç¨‹åºï¼ŒåŒ…æ‹¬ï¼š
# - kubelet
# - docker daemon  
# - ç³»çµ±ç¨‹åº
# - å…¶ä»–å®¹å™¨çš„ç¨‹åº

# ç”šè‡³å¯ä»¥æ®ºæ­»ä¸»æ©Ÿç¨‹åº
kill -9 <host_process_pid>
```

### ğŸ”— hostIPC (Host Inter-Process Communication)

**åŠŸèƒ½**ï¼šå®¹å™¨æ˜¯å¦ä½¿ç”¨ä¸»æ©Ÿçš„ IPC å‘½åç©ºé–“

```yaml
# å±éšªé…ç½®
apiVersion: v1  
kind: Pod
spec:
  hostIPC: true  # å¯ä»¥å­˜å–ä¸»æ©Ÿçš„ IPC è³‡æº
  containers:
  - name: app
    image: myapp
```

**å±å®³ç¤ºä¾‹**ï¼š
```bash
# åœ¨å®¹å™¨å…§å¯ä»¥å­˜å–ä¸»æ©Ÿçš„ï¼š
# - å…±äº«è¨˜æ†¶é«”æ®µ
# - è¨Šæ¯ä½‡åˆ—  
# - ä¿¡è™Ÿé‡

# æª¢è¦–ä¸»æ©Ÿ IPC è³‡æº
ipcs -a
# å¯èƒ½æ´©éœ²å…¶ä»–æ‡‰ç”¨ç¨‹å¼çš„æ•æ„Ÿè³‡æ–™
```

### ğŸ›¡ï¸ å®‰å…¨å»ºè­°

```yaml
# å®‰å…¨é…ç½®
apiVersion: v1
kind: Pod  
spec:
  hostPID: false   # é è¨­å€¼ï¼Œæ˜ç¢ºè¨­å®š
  hostIPC: false   # é è¨­å€¼ï¼Œæ˜ç¢ºè¨­å®š
  hostNetwork: false
  securityContext:
    runAsNonRoot: true
```

## OPA Gatekeeper è©³è§£

### ğŸšª ä»€éº¼æ˜¯ OPA Gatekeeper

**Open Policy Agent (OPA)**ï¼šé€šç”¨çš„ç­–ç•¥å¼•æ“
**Gatekeeper**ï¼šOPA åœ¨ Kubernetes ä¸­çš„å¯¦ä½œ

### ğŸ—ï¸ æ¶æ§‹çµ„æˆ

```
kubectl create/update
        â†“
   API Server
        â†“
   Gatekeeper (Admission Controller)
        â†“
   OPA Engine (è©•ä¼°ç­–ç•¥)
        â†“
   å…è¨±/æ‹’çµ•è«‹æ±‚
```

### ğŸ“‹ Gatekeeper çµ„ä»¶

**1. ConstraintTemplateï¼ˆç´„æŸæ¨¡æ¿ï¼‰**
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      properties:
        labels:
          type: array
          items:
            type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels
        
        violation[{"msg": msg}] {
          required := input.parameters.labels
          provided := input.review.object.metadata.labels
          missing := required[_]
          not provided[missing]
          msg := sprintf("ç¼ºå°‘å¿…è¦æ¨™ç±¤: %v", [missing])
        }
```

**2. Constraintï¼ˆå…·é«”ç´„æŸï¼‰**
```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: must-have-environment
spec:
  match:
    kinds:
      - apiGroups: ["apps"]
        kinds: ["Deployment"]
  parameters:
    labels: ["environment", "team"]
```

### ğŸ¯ å¯¦ç”¨ç­–ç•¥ç¯„ä¾‹

**ç¦æ­¢ç‰¹æ¬Šå®¹å™¨**
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8spspprivileged
spec:
  crd:
    spec:
      names:
        kind: K8sPSPPrivileged
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8spspprivileged
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          container.securityContext.privileged == true
          msg := "ç‰¹æ¬Šå®¹å™¨è¢«ç¦æ­¢"
        }
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.initContainers[_]
          container.securityContext.privileged == true  
          msg := "Init å®¹å™¨ä¸èƒ½ä½¿ç”¨ç‰¹æ¬Šæ¨¡å¼"
        }
```

**å¼·åˆ¶ä½¿ç”¨é root ç”¨æˆ¶**
```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8spsprunasnonroot
spec:
  crd:
    spec:
      names:
        kind: K8sPSPRunAsNonRoot
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8spsprunasnonroot
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          container.securityContext.runAsUser == 0
          msg := "å®¹å™¨ä¸èƒ½ä»¥ root ç”¨æˆ¶é‹è¡Œ"
        }
        
        violation[{"msg": msg}] {
          not input.review.object.spec.securityContext.runAsNonRoot
          msg := "å¿…é ˆè¨­å®š runAsNonRoot: true"
        }
```

### ğŸ” ç›£æ§å’Œé™¤éŒ¯

**æª¢æŸ¥é•è¦**
```bash
# æŸ¥çœ‹æ‰€æœ‰ç´„æŸç‹€æ…‹
kubectl get constraints

# æª¢æŸ¥ç‰¹å®šç´„æŸçš„é•è¦
kubectl describe k8srequiredlabels must-have-environment

# æŸ¥çœ‹ Gatekeeper æ—¥èªŒ
kubectl logs -n gatekeeper-system deployment/gatekeeper-controller-manager
```

**æ¸¬è©¦ç­–ç•¥**
```bash
# å˜—è©¦å‰µå»ºä¸ç¬¦åˆç­–ç•¥çš„è³‡æº
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-deployment
  # æ•…æ„ä¸åŠ å¿…è¦æ¨™ç±¤
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test
  template:
    metadata:
      labels:
        app: test
    spec:
      containers:
      - name: test
        image: nginx
EOF

# æ‡‰è©²æœƒè¢«æ‹’çµ•ä¸¦é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
```

### ğŸš€ éƒ¨ç½² Gatekeeper

```bash
# å®‰è£ Gatekeeper
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.14/deploy/gatekeeper.yaml

# é©—è­‰å®‰è£
kubectl get pods -n gatekeeper-system
kubectl get crd | grep gatekeeper
```

é€™äº›å·¥å…·å’Œæ¦‚å¿µæ§‹æˆäº† Kubernetes å®‰å…¨é˜²è­·çš„é‡è¦åŸºç¤ï¼Œå»ºè­°æŒ‰ç…§ã€Œæœ€å°æ¬Šé™åŸå‰‡ã€å’Œã€Œç¸±æ·±é˜²ç¦¦ã€ç­–ç•¥ä¾†é…ç½®ã€‚



