# Kubernetes 容器安全設定檢查清單

## 1. 容器映像安全

### 1.1 基礎映像安全
- [ ] 使用官方或可信的基礎映像
- [ ] 使用最小化的基礎映像（如 Alpine、Distroless）
- [ ] 定期更新基礎映像到最新版本
- [ ] 掃描映像漏洞（使用 Trivy、Clair 等工具）
- [ ] 設置映像漏洞掃描自動化流程
- [ ] 禁用或移除不必要的套件和服務

### 1.2 映像建構安全
- [ ] 使用 multi-stage builds 減少映像攻擊面
- [ ] 在 Dockerfile 中創建非 root 用戶
- [ ] 設置適當的檔案權限
- [ ] 清理暫存檔案和快取
- [ ] 避免在映像中包含機敏資料
- [ ] 使用 .dockerignore 檔案排除不需要的檔案

### 1.3 映像簽名和驗證
- [ ] 實施映像簽名機制（使用 Cosign 或 Notary）
- [ ] 配置映像簽名驗證策略
- [ ] 建立可信的映像倉庫
- [ ] 實施映像准入控制（Admission Controller）

## 2. Kubernetes 叢集安全

### 2.1 API Server 安全
- [ ] 啟用 RBAC（Role-Based Access Control）
- [ ] 配置 API Server 審計日誌
- [ ] 啟用 TLS 加密通訊
- [ ] 配置 API Server 認證機制
- [ ] 限制匿名存取
- [ ] 配置 API Server 防火牆規則

### 2.2 etcd 安全
- [ ] 啟用 etcd 資料加密
- [ ] 配置 etcd 備份和恢復策略
- [ ] 限制 etcd 存取權限
- [ ] 啟用 etcd TLS 通訊
- [ ] 定期輪換 etcd 憑證

### 2.3 節點安全
- [ ] 定期更新節點作業系統
- [ ] 配置節點防火牆規則
- [ ] 禁用不必要的服務
- [ ] 配置節點日誌監控
- [ ] 實施節點存取控制

## 3. Pod 安全配置

### 3.1 Security Context
- [ ] 設置 `runAsNonRoot: true`
- [ ] 指定 `runAsUser` 和 `runAsGroup`
- [ ] 設置 `readOnlyRootFilesystem: true`
- [ ] 配置 `fsGroup` 設置
- [ ] 禁用特權模式 `privileged: false`
- [ ] 設置 `allowPrivilegeEscalation: false`

```yaml
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 3000
  fsGroup: 2000
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
    add:
    - NET_BIND_SERVICE
```

### 3.2 Capabilities 管理
- [ ] 移除所有不必要的 Linux capabilities
- [ ] 只添加必需的 capabilities
- [ ] 避免使用 `CAP_SYS_ADMIN`
- [ ] 定期審查 capabilities 使用

### 3.3 AppArmor/SELinux
- [ ] 啟用 AppArmor 或 SELinux
- [ ] 配置自定義安全配置檔
- [ ] 定期審查和更新安全配置檔

## 4. 網路安全

### 4.1 Network Policies
- [ ] 實施預設拒絕的網路策略
- [ ] 為每個應用程式配置特定的網路策略
- [ ] 限制 Pod 間通訊
- [ ] 配置 Ingress 和 Egress 規則
- [ ] 實施微分段（Micro-segmentation）

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

### 4.2 Service Mesh 安全
- [ ] 實施 mTLS（mutual TLS）
- [ ] 配置服務間認證
- [ ] 實施流量加密
- [ ] 配置服務授權策略

### 4.3 Ingress 安全
- [ ] 使用 TLS/SSL 憑證
- [ ] 配置 WAF（Web Application Firewall）
- [ ] 實施速率限制
- [ ] 配置 IP 白名單

## 5. 機敏資料管理

### 5.1 Secrets 管理
- [ ] 使用 Kubernetes Secrets 存儲機敏資料
- [ ] 啟用 Secret 加密存儲
- [ ] 實施 Secret 輪換策略
- [ ] 限制 Secret 存取權限
- [ ] 考慮使用外部秘密管理系統（HashiCorp Vault、AWS Secrets Manager）

### 5.2 ConfigMaps 安全
- [ ] 避免在 ConfigMaps 中存儲機敏資料
- [ ] 實施 ConfigMap 存取控制
- [ ] 定期審查 ConfigMap 內容

## 6. 資源限制和配額

### 6.1 Resource Limits
- [ ] 為所有容器設置 CPU 和記憶體限制
- [ ] 配置 requests 和 limits
- [ ] 實施 LimitRanges
- [ ] 設置 ResourceQuotas

```yaml
resources:
  requests:
    memory: "64Mi"
    cpu: "250m"
  limits:
    memory: "128Mi"
    cpu: "500m"
```

### 6.2 Pod Security Standards
- [ ] 實施 Pod Security Standards（PSS）
- [ ] 配置 restricted 安全級別
- [ ] 使用 Pod Security Admission
- [ ] 定期審查安全策略

## 7. 監控和日誌

### 7.1 審計日誌
- [ ] 啟用 Kubernetes 審計日誌
- [ ] 配置審計策略
- [ ] 實施日誌集中化管理
- [ ] 設置異常行為告警

### 7.2 運行時監控
- [ ] 部署運行時安全監控工具（Falco）
- [ ] 監控容器行為異常
- [ ] 實施入侵檢測系統
- [ ] 配置安全事件響應流程

### 7.3 合規性監控
- [ ] 實施安全合規性掃描（kube-bench、kube-hunter）
- [ ] 定期進行安全評估
- [ ] 配置合規性報告

## 8. 准入控制

### 8.1 Admission Controllers
- [ ] 啟用必要的 Admission Controllers
- [ ] 配置 ValidatingAdmissionWebhook
- [ ] 配置 MutatingAdmissionWebhook
- [ ] 實施 OPA Gatekeeper 策略

### 8.2 策略即程式碼
- [ ] 實施 Rego 策略
- [ ] 版本控制安全策略
- [ ] 自動化策略測試
- [ ] 實施策略變更審查流程

## 9. 備份和災難恢復

### 9.1 資料備份
- [ ] 實施定期備份策略
- [ ] 測試備份恢復流程
- [ ] 加密備份資料
- [ ] 實施異地備份

### 9.2 叢集恢復
- [ ] 制定災難恢復計劃
- [ ] 定期進行恢復演練
- [ ] 文件化恢復程序

## 10. 安全更新和維護

### 10.1 定期維護
- [ ] 制定安全更新排程
- [ ] 自動化安全補丁管理
- [ ] 定期進行安全評估
- [ ] 實施漏洞管理流程

### 10.2 事件響應
- [ ] 制定安全事件響應計劃
- [ ] 培訓安全響應團隊
- [ ] 實施事件追蹤和報告
- [ ] 定期進行事件響應演練

## 11. 開發和部署安全

### 11.1 CI/CD 安全
- [ ] 實施安全的 CI/CD 流程
- [ ] 在 pipeline 中集成安全掃描
- [ ] 實施程式碼簽名
- [ ] 配置安全門檻

### 11.2 供應鏈安全
- [ ] 驗證第三方組件安全性
- [ ] 實施 SBOM（Software Bill of Materials）
- [ ] 監控依賴漏洞
- [ ] 實施供應商風險評估

## 12. 教育和培訓

- [ ] 提供容器安全培訓
- [ ] 定期更新安全知識
- [ ] 建立安全最佳實踐文件
- [ ] 實施安全意識計劃

---

## 實施優先級建議

### 高優先級（立即實施）
1. Pod Security Context 配置
2. RBAC 設置
3. Network Policies
4. 映像漏洞掃描
5. Secrets 管理

### 中優先級（3個月內）
1. 運行時監控
2. 审计日誌
3. Admission Controllers
4. 資源限制

### 低優先級（6個月內）
1. Service Mesh
2. 合規性監控
3. 高級策略配置
4. 自動化工具整合

此檢查清單應定期審查和更新，以確保符合最新的安全最佳實踐和威脅環境。
